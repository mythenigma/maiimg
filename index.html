<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="keywords" content="image hosting,image upload,photo sharing,image qr code,free image host,secure image sharing">
  <meta name="description" content="Upload and share images instantly with QR codes. Secure, fast, and free image hosting service with tracking and analytics.">
  <!-- Favicon -->
      <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="alternate icon" type="image/x-icon" href="favicon.ico">
    <link rel="shortcut icon" type="image/svg+xml" href="favicon.svg">
  <meta name="author" content="MaiPDF">
  
  <!-- SEO -->
  <link rel="sitemap" type="application/xml" href="/sitemap.xml">
  <meta name="robots" content="index, follow">
  <title>Image QR Generator - Upload & Share Images with QR Codes</title>

  <!-- Google AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9224406325142860" crossorigin="anonymous"></script>

  <!-- Cloudflare CDN Resources -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/dropzone.min.css" rel="stylesheet">
  
  <!-- Custom Styles -->
  <link href="qr-styles010.css" rel="stylesheet">
  
  <!-- Internationalization -->
  <script src="i18n.js?v=2026021902"></script>
</head>

<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg fixed-top">
    <div class="container">
      <a class="navbar-brand" href="#hero">
        <i class="fas fa-images me-2"></i><span data-translate="nav.title">Image QR Generator</span>
      </a>
      
      <!-- Desktop User/Auth + Language -->
      <div class="nav-actions-desktop d-none d-md-flex align-items-center gap-2">
        <div id="userInfo" class="small d-none user-pill"></div>
        <a href="dashboard.html" class="btn btn-light btn-sm d-none" id="dashboardBtn">
          <i class="fas fa-th-large me-1"></i><span data-translate="dash.title">My Galleries</span>
        </a>
        <button type="button" class="btn btn-light btn-sm" id="loginBtn" data-bs-toggle="modal" data-bs-target="#loginModal">
          <i class="fas fa-sign-in-alt me-1"></i><span data-translate="auth.login">Login</span>
        </button>
        <button type="button" class="btn btn-light btn-sm d-none" id="logoutBtn">
          <i class="fas fa-sign-out-alt me-1"></i><span data-translate="auth.logout">Logout</span>
        </button>

        <div class="language-selector">
          <div class="dropdown">
            <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" id="languageDropdown" data-bs-toggle="dropdown" aria-expanded="false">
              <span id="currentLanguageFlag">ğŸ‡ºğŸ‡¸</span>
              <span id="currentLanguageName" data-translate="language.english">English</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="languageDropdown">
              <li><a class="dropdown-item" href="#" onclick="changeLanguage('en'); return false;"><span class="flag-icon">ğŸ‡ºğŸ‡¸</span><span data-translate="language.english">English</span></a></li>
              <li><a class="dropdown-item" href="#" onclick="changeLanguage('zh'); return false;"><span class="flag-icon">ğŸ‡¨ğŸ‡³</span><span data-translate="language.chinese">ä¸­æ–‡</span></a></li>
              <li><a class="dropdown-item" href="#" onclick="changeLanguage('tw'); return false;"><span class="flag-icon">ğŸ‡¹ğŸ‡¼</span><span data-translate="language.taiwan">ä¸­è¯æ°‘åœ‹</span></a></li>
              <li><a class="dropdown-item" href="#" onclick="changeLanguage('ja'); return false;"><span class="flag-icon">ğŸ‡¯ğŸ‡µ</span><span data-translate="language.japanese">æ—¥æœ¬èª</span></a></li>
              <li><a class="dropdown-item" href="#" onclick="changeLanguage('de'); return false;"><span class="flag-icon">ğŸ‡©ğŸ‡ª</span><span data-translate="language.german">Deutsch</span></a></li>
              <li><a class="dropdown-item" href="#" onclick="changeLanguage('ko'); return false;"><span class="flag-icon">ğŸ‡°ğŸ‡·</span><span data-translate="language.korean">í•œêµ­ì–´</span></a></li>
              <li><a class="dropdown-item" href="#" onclick="changeLanguage('fr'); return false;"><span class="flag-icon">ğŸ‡«ğŸ‡·</span><span data-translate="language.french">FranÃ§ais</span></a></li>
              <li><a class="dropdown-item" href="#" onclick="changeLanguage('it'); return false;"><span class="flag-icon">ğŸ‡®ğŸ‡¹</span><span data-translate="language.italian">Italiano</span></a></li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Mobile User Menu -->
      <div class="nav-actions-mobile dropdown d-md-none">
        <button class="btn btn-light mobile-user-trigger" type="button" id="mobileUserMenuBtn" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Open user menu">
          <i class="fas fa-user-circle"></i>
          <span class="mobile-user-sep">/</span>
          <span id="mobileCurrentLanguageFlag" class="mobile-lang-flag" aria-hidden="true">ğŸ‡ºğŸ‡¸</span>
        </button>
        <ul class="dropdown-menu dropdown-menu-end mobile-user-menu" aria-labelledby="mobileUserMenuBtn">
          <li><h6 class="dropdown-header" id="mobileUserEmail">Guest</h6></li>
          <li><a href="dashboard.html" class="dropdown-item d-none" id="mobileDashboardBtn"><i class="fas fa-th-large me-2"></i><span data-translate="dash.title">My Galleries</span></a></li>
          <li><button type="button" class="dropdown-item" id="mobileLoginBtn" data-bs-toggle="modal" data-bs-target="#loginModal"><i class="fas fa-sign-in-alt me-2"></i><span data-translate="auth.login">Login</span></button></li>
          <li><button type="button" class="dropdown-item d-none" id="mobileLogoutBtn"><i class="fas fa-sign-out-alt me-2"></i><span data-translate="auth.logout">Logout</span></button></li>
          <li><hr class="dropdown-divider"></li>
          <li><span class="dropdown-item-text mobile-lang-title">Language</span></li>
          <li><a class="dropdown-item" href="#" onclick="changeLanguage('en'); return false;">ğŸ‡ºğŸ‡¸ English</a></li>
          <li><a class="dropdown-item" href="#" onclick="changeLanguage('zh'); return false;">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</a></li>
          <li><a class="dropdown-item" href="#" onclick="changeLanguage('tw'); return false;">ğŸ‡¹ğŸ‡¼ ä¸­è¯æ°‘åœ‹</a></li>
          <li><a class="dropdown-item" href="#" onclick="changeLanguage('ja'); return false;">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</a></li>
          <li><a class="dropdown-item" href="#" onclick="changeLanguage('de'); return false;">ğŸ‡©ğŸ‡ª Deutsch</a></li>
          <li><a class="dropdown-item" href="#" onclick="changeLanguage('ko'); return false;">ğŸ‡°ğŸ‡· í•œêµ­ì–´</a></li>
          <li><a class="dropdown-item" href="#" onclick="changeLanguage('fr'); return false;">ğŸ‡«ğŸ‡· FranÃ§ais</a></li>
          <li><a class="dropdown-item" href="#" onclick="changeLanguage('it'); return false;">ğŸ‡®ğŸ‡¹ Italiano</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Hero Section -->
  <section class="hero-section" id="hero">
    <div class="container">
      <h1 class="hero-title">
        <i class="fas fa-cloud-upload-alt"></i><br>
        <span data-translate="hero.title">Upload & Share Images</span>
      </h1>
      <p class="hero-subtitle" data-translate="hero.subtitle">
        Turn your images into shareable QR codes with advanced tracking and analytics
      </p>
    </div>
  </section>

  <div class="container">
    <!-- Main Upload Section -->
    <section class="main-upload-section" id="upload">
      <div class="text-center mb-4">
        <h2 class="section-title" data-translate="upload.title">Image Upload Center</h2>
        <p class="section-subtitle" data-translate="upload.subtitle">Drag & drop your images or click to browse</p>
        
        <!-- Feature Badges -->
        <div class="feature-badges mb-4">
          <span class="badge badge-secure">
            <i class="fas fa-shield-alt"></i>
            <span data-translate="badges.secure">Secure</span>
          </span>
          <span class="badge badge-fast">
            <i class="fas fa-bolt"></i>
            <span data-translate="badges.fast">Fast</span>
          </span>
          <span class="badge badge-free">
            <i class="fas fa-gift"></i>
            <span data-translate="badges.free">Free</span>
          </span>
        </div>
      </div>

      <!-- Upload Zone -->
      <div class="upload-area" id="dropz">
        <i class="fas fa-cloud-upload-alt upload-icon"></i>
        <div class="upload-text" data-translate="upload.dropText">Drop images here or click to upload</div>
        <div class="upload-subtext" data-translate="upload.supportText">
          Supports: PNG, JPG, JPEG, GIF, WebP â€¢ Max 50MB each â€¢ Up to 25 files
        </div>
        <div class="mt-3">
          <span class="badge bg-primary px-3 py-2">
            <span data-translate="badges.secure">Secure</span>
          </span>
          <span class="badge bg-success px-3 py-2">
            <span data-translate="badges.fast">Fast</span>
          </span>
          <span class="badge bg-info px-3 py-2">
            <span data-translate="badges.free">Free</span>
          </span>
        </div>
      </div>

      <div class="row">
        <div class="col-12 mb-4">
          <div class="alert alert-info border-0 rounded-4" id="uploadStatus">
            <i class="fas fa-info-circle me-2"></i>
            <span id="pleaseupload" data-translate="upload.ready">Ready to upload images</span>
          </div>
        </div>
      </div>

      <!-- File Preview Area -->
      <div class="file-preview-area" id="filePreviewArea" style="display: none;">
        <h4>Selected Images</h4>
        <div class="file-grid" id="fileGrid"></div>
      </div>
    </section>

    <!-- Configuration Section -->
    <section class="config-section" id="config">
      <div class="feature-cards">
        <div class="feature-card">
          <i class="fas fa-shield-alt feature-icon"></i>
          <h5 class="feature-title" data-translate="features.accessControl.title">Access Control</h5>
          <input class="form-control mb-2" type="number" id="limit" data-translate-placeholder="features.viewLimit.placeholder" placeholder="Max views (required)" min="1" max="99999999" required>
          <input class="form-control" type="number" id="password" data-translate-placeholder="features.timeControl.placeholder" placeholder="Seconds per view (required)" min="1" max="99999999" required>
          <small class="text-muted" data-translate="features.accessControl.description">Set both view limit and per-view duration in one panel</small>
        </div>

        <div class="feature-card">
          <i class="fas fa-hourglass-half feature-icon"></i>
          <h5 class="feature-title" data-translate="features.expiration.title">Expiration</h5>
          <select class="form-select mb-2" id="expiration_preset" aria-label="Expiration preset">
            <option value="" selected data-translate="features.expiration.select">Select expiration</option>
            <option value="1h" data-translate="features.expiration.option1h">1 hour</option>
            <option value="3h" data-translate="features.expiration.option3h">3 hours</option>
            <option value="24h" data-translate="features.expiration.option24h">24 hours</option>
            <option value="5d" data-translate="features.expiration.option5d">5 days</option>
            <option value="custom" data-translate="features.expiration.custom">Custom days</option>
            <option value="unlimited" data-translate="features.expiration.unlimited">Unlimited</option>
          </select>
          <input class="form-control mb-2" type="number" id="expiration_custom_days" min="1" step="1" data-translate-placeholder="features.expiration.customPlaceholder" placeholder="Custom days" style="display:none;">
          <input type="hidden" id="expiration_day" value="">
          <input type="hidden" id="expiration_ts" value="">
          <small class="text-muted d-block mb-1" id="expiration_result" style="display:none;" data-translate="features.expiration.utcNone">UTC expiry time: -</small>
          <div id="timezone_row" style="display:none;">
            <select class="form-select form-select-sm mb-2" id="timezone_tz" aria-label="Time zone"></select>
          </div>
          <small class="text-muted d-block" id="expiration_local" style="display:none;" data-translate="features.expiration.localNone">Local time: -</small>
        </div>
        
        <div class="feature-card">
          <i class="fas fa-tag feature-icon"></i>
          <h5 class="feature-title" data-translate="features.description.title">Description</h5>
          <input class="form-control mb-2" type="text" id="caption" data-translate-placeholder="features.description.placeholder" placeholder="Add a description (required)" maxlength="100" required>
          <small class="text-muted d-block mb-2" data-translate="features.description.description">Enter image description</small>
          <h5 class="feature-title" data-translate="features.generate.title">Generate Link & QR</h5>
          <button type="button" class="btn btn-primary w-100" onclick="generateImageQR()" disabled id="generateBtn">
            <i class="fas fa-link me-2"></i><span data-translate="features.generate.button">Create Link & QR Code</span>
          </button>
          <small class="text-muted" id="generateBtnStatus" data-translate="features.generate.status">Fill all fields and upload images first</small>
        </div>
      </div>
    </section>

    <!-- Results Section -->
    <section id="results" class="results-section" style="display: none;">
      <!-- Success Header with Animation -->
      <div class="success-header text-center mb-5">
        <div class="success-icon-container">
          <i class="fas fa-check-circle success-icon"></i>
        </div>
        <h2 class="success-title">
          <span data-translate="results.success">QR Code Generated Successfully!</span>
        </h2>
        <p class="success-subtitle" data-translate="results.subtitle">Your image gallery link and QR code are ready to share</p>
      </div>

      <!-- Enhanced Statistics Cards -->
      <div class="stats-container mb-3">
        <div class="row g-2">
          <div class="col-md-4 col-sm-6">
            <div class="stat-card-enhanced">
              <div class="stat-icon">
                <i class="fas fa-images"></i>
              </div>
              <div class="stat-content">
                <div class="stat-number" id="fileCount">0</div>
                <div class="stat-label" data-translate="results.stats.images">Images</div>
              </div>
            </div>
          </div>
          <div class="col-md-4 col-sm-6">
            <div class="stat-card-enhanced">
              <div class="stat-icon">
                <i class="fas fa-eye"></i>
              </div>
              <div class="stat-content">
                <div class="stat-number" id="viewLimit">âˆ</div>
                <div class="stat-label" data-translate="results.stats.views">Views</div>
              </div>
            </div>
          </div>
          <div class="col-md-4 col-sm-12">
            <div class="stat-card-enhanced">
              <div class="stat-icon">
                <i class="fas fa-hourglass-half"></i>
              </div>
              <div class="stat-content">
                <div class="stat-number" id="expirationDisplay">Never</div>
                <div class="stat-label" data-translate="results.stats.expiration">Expiration</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content Cards -->
      <div class="row g-4 mb-5 align-items-stretch">
        <!-- Share Link & QR Code -->
        <div class="col-12 col-lg-7">
          <div class="result-card h-100" id="share-link-section">
            <div class="result-card-body">
              <div class="share-link-container">
                <div class="gallery-link-header">
                  <label class="form-label mb-0" id="gallery-link-title">Gallery Link</label>
                  <span class="gallery-link-arrow" aria-hidden="true">
                    <i class="fas fa-arrow-right"></i>
                  </span>
                  <a href="#insights-section" class="gallery-link-jump" title="Go to Insights">
                    <i class="fas fa-chart-line"></i>
                  </a>
                </div>
                <div class="input-group mb-2">
                  <input type="text" class="form-control" id="webinputpic" readonly placeholder="Generated link will appear here">
                  <button class="btn btn-primary" type="button" onclick="myFunctionpic()">
                    <i class="fas fa-copy me-1"></i>Copy
                  </button>
                </div>
                <div id="Copied" class="copy-feedback"></div>
              </div>

              <div class="inline-qr-block text-center mt-3">
                <div id="qrcodewebpic" class="qr-container-enhanced">
                  <p class="text-muted">QR code will appear here</p>
                </div>
                <small class="text-muted mt-2 d-block">Scan to access gallery</small>
              </div>
              
              <div class="action-buttons mt-3">
                <button type="button" class="btn btn-success me-2" onclick="window.open(document.getElementById('webinputpic').value, '_blank')">
                  <i class="fas fa-external-link-alt me-1"></i><span data-translate="results.openGallery">Open Gallery</span>
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="location.reload()">
                  <i class="fas fa-plus me-1"></i><span data-translate="results.createAnother">Create Another</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Tracking Information -->
        <div class="col-12 col-lg-5">
          <div class="result-card tracking-card h-100" id="insights-section">
            <div class="result-card-header">
              <h5><i class="fas fa-list-check me-2"></i>Access Records</h5>
            </div>
            <div class="result-card-body">
              <div id="btypesay" class="tracking-info">
                <!-- Insight info will be inserted here -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Tools Section -->
    <section class="tools-section" id="tools">
      <div class="container">
        <div class="text-center mb-5">
          <h2 class="section-title" data-translate="tools.title">Other QR Tools</h2>
          <p class="section-subtitle" data-translate="tools.subtitle">Quick access to other QR code generators</p>
        </div>
        
        <div class="row g-4">
          <div class="col-md-3 col-sm-6">
            <div class="tool-card" data-bs-toggle="modal" data-bs-target="#wifi-modal">
              <div class="tool-icon">
                <i class="fas fa-wifi"></i>
              </div>
              <h5 data-translate="tools.wifi">WiFi QR</h5>
            </div>
          </div>
          
          <div class="col-md-3 col-sm-6">
            <div class="tool-card" data-bs-toggle="modal" data-bs-target="#sms-modal">
              <div class="tool-icon">
                <i class="fas fa-sms"></i>
              </div>
              <h5 data-translate="tools.sms">SMS QR</h5>
            </div>
          </div>
          
          <div class="col-md-3 col-sm-6">
            <div class="tool-card" data-bs-toggle="modal" data-bs-target="#url-modal">
              <div class="tool-icon">
                <i class="fas fa-link"></i>
              </div>
              <h5 data-translate="tools.url">URL QR</h5>
            </div>
          </div>
          
          <div class="col-md-3 col-sm-6">
            <div class="tool-card" data-bs-toggle="modal" data-bs-target="#phone-modal">
              <div class="tool-icon">
                <i class="fas fa-phone"></i>
              </div>
              <h5 data-translate="tools.phone">Phone QR</h5>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- WiFi QR Code Modal -->
  <div class="modal fade" id="wifi-modal" tabindex="-1" aria-labelledby="wifiModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="wifiModalLabel">
            <i class="fas fa-wifi me-2"></i><span data-translate="modals.wifi.title">WiFi QR Code Generator</span>
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="myInput1" class="form-label" data-translate="modals.wifi.networkName">Network Name (SSID)</label>
            <input type="text" class="form-control" id="myInput1" data-translate-placeholder="modals.wifi.networkPlaceholder" placeholder="Enter WiFi network name">
          </div>
          
          <div class="mb-3">
            <label for="myInput2" class="form-label" data-translate="modals.wifi.securityType">Security Type</label>
            <select class="form-control" id="myInput2">
              <option value="WPA" data-translate="modals.wifi.wpa">WPA/WPA2</option>
              <option value="WEP" data-translate="modals.wifi.wep">WEP</option>
              <option value="nopass" data-translate="modals.wifi.noPassword">No Password</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="myInput3" class="form-label" data-translate="modals.wifi.password">Password</label>
            <input type="password" class="form-control" id="myInput3" data-translate-placeholder="modals.wifi.passwordPlaceholder" placeholder="Enter WiFi password">
          </div>
          
          <button type="button" class="btn btn-primary w-100" onclick="makeCode()">
            <i class="fas fa-qrcode me-2"></i><span data-translate="modals.wifi.generate">Generate WiFi QR Code</span>
          </button>
          
          <div class="mt-4">
            <h6><i class="fas fa-qrcode me-2"></i><span data-translate="modals.common.qrPreview">QR Code Preview</span></h6>
            <div id="qrcode" class="qr-container">
              <p class="text-muted" data-translate="modals.common.qrPlaceholder">Your WiFi QR code will appear here</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SMS QR Code Modal -->
  <div class="modal fade" id="sms-modal" tabindex="-1" aria-labelledby="smsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="smsModalLabel">
            <i class="fas fa-sms me-2"></i><span data-translate="modals.sms.title">SMS QR Code Generator</span>
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="smsNumber" class="form-label" data-translate="modals.sms.phoneNumber">Phone Number</label>
            <input type="tel" class="form-control" id="smsNumber" data-translate-placeholder="modals.sms.phonePlaceholder" placeholder="Enter phone number">
          </div>
          
          <div class="mb-3">
            <label for="smsContent" class="form-label" data-translate="modals.sms.messageContent">Message Content</label>
            <textarea class="form-control" rows="4" id="smsContent" data-translate-placeholder="modals.sms.messagePlaceholder" placeholder="Enter your message"></textarea>
          </div>
          
          <button type="button" class="btn btn-primary w-100" onclick="makeCode()">
            <i class="fas fa-qrcode me-2"></i><span data-translate="modals.sms.generate">Generate SMS QR Code</span>
          </button>
          
          <div class="mt-4">
            <h6><i class="fas fa-qrcode me-2"></i><span data-translate="modals.common.qrPreview">QR Code Preview</span></h6>
            <div id="smsCode" class="qr-container">
              <p class="text-muted" data-translate="modals.common.qrPlaceholder">Your SMS QR code will appear here</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Phone QR Code Modal -->
  <div class="modal fade" id="phone-modal" tabindex="-1" aria-labelledby="phoneModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="phoneModalLabel">
            <i class="fas fa-phone me-2"></i><span data-translate="modals.phone.title">Phone QR Code Generator</span>
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="telinput" class="form-label" data-translate="modals.phone.phoneNumber">Phone Number</label>
            <input type="tel" class="form-control" id="telinput" data-translate-placeholder="modals.phone.phonePlaceholder" placeholder="Enter phone number">
          </div>
          
          <button type="button" class="btn btn-primary w-100" onclick="makeCodeweb()">
            <i class="fas fa-qrcode me-2"></i><span data-translate="modals.phone.generate">Generate Phone QR Code</span>
          </button>
          
          <div class="mt-4">
            <h6><i class="fas fa-qrcode me-2"></i><span data-translate="modals.common.qrPreview">QR Code Preview</span></h6>
            <div id="qrcodetel" class="qr-container">
              <p class="text-muted" data-translate="modals.common.qrPlaceholder">Your phone QR code will appear here</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- URL QR Code Modal -->
  <div class="modal fade" id="url-modal" tabindex="-1" aria-labelledby="urlModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="urlModalLabel">
            <i class="fas fa-link me-2"></i><span data-translate="modals.url.title">URL QR Code Generator</span>
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="webinput" class="form-label" data-translate="modals.url.websiteUrl">Website URL</label>
            <input type="url" class="form-control" id="webinput" value="https://" data-translate-placeholder="modals.url.urlPlaceholder" placeholder="Enter website URL">
          </div>
          
          <button type="button" class="btn btn-primary w-100" onclick="makeCodeweb()">
            <i class="fas fa-qrcode me-2"></i><span data-translate="modals.url.generate">Generate URL QR Code</span>
          </button>
          
          <div class="mt-4">
            <h6><i class="fas fa-qrcode me-2"></i><span data-translate="modals.common.qrPreview">QR Code Preview</span></h6>
            <div id="qrcodeweb" class="qr-container">
              <p class="text-muted" data-translate="modals.common.qrPlaceholder">Your URL QR code will appear here</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Auth Modal -->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 420px;">
      <div class="modal-content" style="border-radius: 16px; border: none;">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title w-100 text-center fw-bold" id="authModalTitle">Sign in to MaiIMG</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body px-4 pb-4">

          <!-- ===== Sign In View ===== -->
          <div id="authSignIn">
            <div class="d-grid gap-2 mb-3">
              <button type="button" class="btn btn-outline-dark d-flex align-items-center justify-content-center gap-2 py-2" id="googleLoginBtn" style="border-radius: 10px;">
                <svg width="20" height="20" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
                <span data-translate="auth.continueGoogle">Continue with Google</span>
              </button>
            </div>
            <div class="position-relative my-3">
              <hr>
              <span class="position-absolute top-50 start-50 translate-middle bg-white px-3 text-muted small" data-translate="auth.orEmail">or sign in with email</span>
            </div>
            <form id="emailLoginForm">
              <div class="mb-2">
                <input type="email" class="form-control" id="loginEmail" data-translate-placeholder="auth.emailPlaceholder" placeholder="Email address" required style="border-radius: 10px;">
              </div>
              <div class="mb-3">
                <input type="password" class="form-control" id="loginPassword" data-translate-placeholder="auth.passwordPlaceholder" placeholder="Password" required style="border-radius: 10px;">
              </div>
              <div class="d-grid">
                <button type="submit" class="btn btn-primary py-2" style="border-radius: 10px;" data-translate="auth.signIn">Sign In</button>
              </div>
            </form>
            <div class="text-center mt-3">
              <a href="#" id="showForgotPassword" class="text-muted small" data-translate="auth.forgotPassword">Forgot password?</a>
            </div>
            <hr>
            <div class="text-center">
              <span class="text-muted small" data-translate="auth.noAccount">Don't have an account?</span>
              <a href="#" id="showSignUp" class="small fw-bold ms-1" data-translate="auth.createAccount">Create Account</a>
            </div>
          </div>

          <!-- ===== Sign Up View ===== -->
          <div id="authSignUp" class="d-none">
            <form id="emailSignUpForm">
              <div class="mb-2">
                <input type="email" class="form-control" id="signUpEmail" data-translate-placeholder="auth.emailPlaceholder" placeholder="Email address" required style="border-radius: 10px;">
              </div>
              <div class="mb-2">
                <input type="password" class="form-control" id="signUpPassword" data-translate-placeholder="auth.passwordMin" placeholder="Password (min 6 characters)" required minlength="6" style="border-radius: 10px;">
              </div>
              <div class="mb-3">
                <input type="password" class="form-control" id="signUpPasswordConfirm" data-translate-placeholder="auth.confirmPassword" placeholder="Confirm password" required minlength="6" style="border-radius: 10px;">
              </div>
              <div class="d-grid">
                <button type="submit" class="btn btn-success py-2" style="border-radius: 10px;" data-translate="auth.createAccount">Create Account</button>
              </div>
            </form>
            <hr>
            <div class="text-center">
              <span class="text-muted small" data-translate="auth.hasAccount">Already have an account?</span>
              <a href="#" id="showSignIn" class="small fw-bold ms-1" data-translate="auth.signIn">Sign In</a>
            </div>
          </div>

          <!-- ===== Forgot Password View ===== -->
          <div id="authForgotPassword" class="d-none">
            <p class="text-muted small text-center mb-3" data-translate="auth.resetDesc">Enter your email and we'll send you a link to reset your password.</p>
            <form id="forgotPasswordForm">
              <div class="mb-3">
                <input type="email" class="form-control" id="resetEmail" data-translate-placeholder="auth.emailPlaceholder" placeholder="Email address" required style="border-radius: 10px;">
              </div>
              <div class="d-grid">
                <button type="submit" class="btn btn-warning py-2" style="border-radius: 10px;" data-translate="auth.sendReset">Send Reset Email</button>
              </div>
            </form>
            <hr>
            <div class="text-center">
              <a href="#" id="backToSignIn" class="small fw-bold" data-translate="auth.backToSignIn">Back to Sign In</a>
            </div>
          </div>

          <!-- ===== Email Verification Notice ===== -->
          <div id="authVerifyEmail" class="d-none text-center">
            <div class="mb-3">
              <i class="fas fa-envelope-open-text fa-3x text-primary"></i>
            </div>
            <h6 class="fw-bold" data-translate="auth.verifyHeading">Verify your email</h6>
            <p class="text-muted small" id="verifyDescText">We've sent a verification email to <strong id="verifyEmailAddr"></strong>. Please check your inbox and click the link to verify.</p>
            <div class="d-grid gap-2">
              <button type="button" class="btn btn-outline-primary py-2" id="resendVerification" style="border-radius: 10px;" data-translate="auth.resendVerification">Resend Verification Email</button>
              <button type="button" class="btn btn-primary py-2" id="verificationDone" style="border-radius: 10px;" data-translate="auth.iveVerified">I've Verified</button>
            </div>
          </div>

          <!-- ===== Success Message ===== -->
          <div id="authSuccess" class="d-none text-center">
            <div class="mb-3">
              <i class="fas fa-check-circle fa-3x text-success"></i>
            </div>
            <p class="fw-bold mb-0" id="authSuccessMsg"></p>
          </div>

          <div id="authError" class="text-danger small mt-2 text-center d-none"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Login Nudge Modal -->
  <div class="modal fade" id="loginNudgeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 420px;">
      <div class="modal-content" style="border-radius: 16px; border: none;">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title w-100 text-center fw-bold" data-translate="auth.loginNudgeTitle">Get Better Control with an Account</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body px-4 pb-4 text-center">
          <p class="text-muted mb-3" data-translate="auth.loginNudgeBody">Sign in to manage galleries, restore links, and view access records from your dashboard.</p>
          <div class="d-grid gap-2">
            <button type="button" class="btn btn-primary py-2" id="loginNudgeSignInBtn" style="border-radius: 10px;" data-translate="auth.loginNudgeSignIn">Sign In</button>
            <button type="button" class="btn btn-outline-secondary py-2" data-bs-dismiss="modal" style="border-radius: 10px;" data-translate="auth.loginNudgeLater">Maybe Later</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    <div class="container">
      <div class="footer-links mb-3">
        <a href="blog/">
          <i class="fas fa-blog me-1"></i>MaiIMG Blog
        </a>
        <a href="https://www.maipdf.com">
          <i class="fas fa-home me-1"></i>MaiPDF Home
        </a>
        <a href="https://article.maipdf.com">
          <i class="fas fa-code me-1"></i>Developer Tools
        </a>
      </div>
      <p class="mb-0">
        <i class="fas fa-copyright me-1"></i>2026 MaiPDF - 
        <a href="mailto:joe@pdfhost.online">joe@pdfhost.online</a>
      </p>
      <small class="text-muted" id="footerComplianceText">Thank you</small>
    </div>
  </footer>

  <!-- Cloudflare CDN Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/dropzone.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
  
  <script>
    // Global variables for generated codes
    let generatedTypeA = 'Reader';
    let generatedTypeB = 'Tracker';
    let uploadedFiles = [];
    let currentUploadSessionId = null; // ä¿æŒä¸º nullï¼Œåœ¨ç¬¬ä¸€æ¬¡ä¸Šä¼ æ—¶ç”Ÿæˆ
    let myDropzone; // æ·»åŠ å…¨å±€å˜é‡æ¥å­˜å‚¨ dropzone å®ä¾‹
    const LOGIN_NUDGE_KEY = 'maiimg_login_nudge_last_ts';
    const LOGIN_NUDGE_COOLDOWN_MS = 60 * 60 * 1000;

    // Language functionality
    let currentLanguage = 'en';

    // Initialize translations when page loads
    function initializeTranslations() {
      // i18n system is already initialized in i18n.js
      // No need to do anything here
    }

    // Change language function
    function changeLanguage(lang) {
      console.log('Changing language to:', lang); // æ·»åŠ è°ƒè¯•æ—¥å¿—
      // Use the global i18n instance from i18n.js
      if (window.i18n) {
        window.i18n.setLanguage(lang);
        currentLanguage = lang;
        syncMobileLanguageFlag(lang);
        updateFooterComplianceText(lang);
        if (typeof window.__updateMaiimgExpiration === 'function') {
          window.__updateMaiimgExpiration();
        }
        
        // ä¿å­˜è¯­è¨€åå¥½åˆ° localStorage
        localStorage.setItem('preferred-language', lang);
        
        console.log('Language changed successfully to:', lang);
      } else {
        console.error('i18n instance not found');
      }
    }

    function getLanguageFlag(lang) {
      const map = {
        en: 'ğŸ‡ºğŸ‡¸',
        zh: 'ğŸ‡¨ğŸ‡³',
        tw: 'ğŸ‡¹ğŸ‡¼',
        ja: 'ğŸ‡¯ğŸ‡µ',
        de: 'ğŸ‡©ğŸ‡ª',
        ko: 'ğŸ‡°ğŸ‡·',
        fr: 'ğŸ‡«ğŸ‡·',
        it: 'ğŸ‡®ğŸ‡¹'
      };
      return map[lang] || map.en;
    }

    function syncMobileLanguageFlag(lang) {
      const flagEl = document.getElementById('mobileCurrentLanguageFlag');
      if (!flagEl) return;
      flagEl.textContent = getLanguageFlag(lang || currentLanguage || 'en');
    }

    // Update all translations on the page
    function updateTranslations() {
      // This is now handled by i18n.js
      if (window.i18n) {
        window.i18n.updatePageTranslations();
      }
    }

    // Update placeholder texts
    function updatePlaceholders() {
      // This is now handled by i18n.js
      if (window.i18n) {
        window.i18n.updatePageTranslations();
      }
    }

    // Get translation for a specific key and language
    function getTranslation(key, lang) {
      // Use the global i18n instance
      if (window.i18n) {
        return window.i18n.t(key);
      }
      return key; // fallback
    }

    // Update footer compliance text based on selected language
    function updateFooterComplianceText(lang) {
      const footerText = document.getElementById('footerComplianceText');
      if (!footerText) return;
      if (lang === 'zh') {
        footerText.innerHTML = '<a href="http://beian.miit.gov.cn/" target="_blank" rel="noopener noreferrer">æ²ªICPå¤‡15021410å·</a>';
      } else {
        footerText.textContent = 'Thank you';
      }
    }

    // å¯é€†å¤æ‚ç¼–ç ç³»ç»Ÿ
    class ReversibleEncoder {
      constructor() {
        // è‡ªå®šä¹‰å­—ç¬¦é›† (é¿å…æ˜“æ··æ·†å­—ç¬¦ 0, O, 1, I, l)
        this.charset = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789abcdefghjkmnpqrstuvwxyz';
        this.base = this.charset.length; // 58
        
        // å›ºå®šå¯†é’¥ (å¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹)
        this.secretKey = 0x5A5A5A5A; // å¼‚æˆ–å¯†é’¥
        
        // å­—ç¬¦æ›¿æ¢æ˜ å°„ (å¢åŠ å¤æ‚åº¦)
        this.charMap = {
          'A': 'X', 'B': 'Y', 'C': 'Z', 'D': 'a', 'E': 'b',
          'F': 'c', 'G': 'd', 'H': 'e', 'J': 'f', 'K': 'g',
          'L': 'h', 'M': 'j', 'N': 'k', 'P': 'm', 'Q': 'n',
          'R': 'p', 'S': 'q', 'T': 'r', 'U': 's', 'V': 't',
          'W': 'u', 'X': 'v', 'Y': 'w', 'Z': 'x', '2': 'y',
          '3': 'z', '4': 'A', '5': 'B', '6': 'C', '7': 'D',
          '8': 'E', '9': 'F', 'a': 'G', 'b': 'H', 'c': 'J',
          'd': 'K', 'e': 'L', 'f': 'M', 'g': 'N', 'h': 'P',
          'j': 'Q', 'k': 'R', 'm': 'S', 'n': 'T', 'p': 'U',
          'q': 'V', 'r': 'W', 's': '2', 't': '3', 'u': '4',
          'v': '5', 'w': '6', 'x': '7', 'y': '8', 'z': '9'
        };
        
        // åå‘æ˜ å°„
        this.reverseCharMap = {};
        for (let [key, value] of Object.entries(this.charMap)) {
          this.reverseCharMap[value] = key;
        }
      }
      
      // è®¡ç®—æ ¡éªŒä½
      calculateChecksum(str) {
        let sum = 0;
        for (let i = 0; i < str.length; i++) {
          sum += str.charCodeAt(i) * (i + 1);
        }
        return this.charset[sum % this.base];
      }
      
      // éªŒè¯æ ¡éªŒä½
      verifyChecksum(str) {
        if (str.length < 2) return false;
        const checksum = str[str.length - 1];
        const data = str.slice(0, -1);
        return this.calculateChecksum(data) === checksum;
      }
      
      // Base58 ç¼–ç 
      toBase58(num) {
        if (num === 0) return this.charset[0];
        
        let result = '';
        while (num > 0) {
          result = this.charset[num % this.base] + result;
          num = Math.floor(num / this.base);
        }
        return result;
      }
      
      // Base58 è§£ç 
      fromBase58(str) {
        let result = 0;
        let power = 1;
        
        for (let i = str.length - 1; i >= 0; i--) {
          const index = this.charset.indexOf(str[i]);
          if (index === -1) throw new Error('Invalid character in encoded string');
          result += index * power;
          power *= this.base;
        }
        return result;
      }
      
      // å­—ç¬¦æ›¿æ¢
      substituteChars(str) {
        return str.split('').map(char => this.charMap[char] || char).join('');
      }
      
      // å­—ç¬¦è¿˜åŸ
      restoreChars(str) {
        return str.split('').map(char => this.reverseCharMap[char] || char).join('');
      }
      
      // ä½ç½®æ‰“æ•£ (ç®€å•çš„å¥‡å¶ä½äº¤æ¢)
      scramblePositions(str) {
        const chars = str.split('');
        const result = [];
        
        // å…ˆæ”¾å¥‡æ•°ä½
        for (let i = 1; i < chars.length; i += 2) {
          result.push(chars[i]);
        }
        // å†æ”¾å¶æ•°ä½
        for (let i = 0; i < chars.length; i += 2) {
          result.push(chars[i]);
        }
        
        return result.join('');
      }
      
      // ä½ç½®è¿˜åŸ
      unscramblePositions(str) {
        const chars = str.split('');
        const result = new Array(chars.length);
        const half = Math.ceil(chars.length / 2);
        
        let oddIndex = 0, evenIndex = 0;
        
        for (let i = 0; i < chars.length; i++) {
          if (i % 2 === 1) {
            result[i] = chars[oddIndex++];
          } else {
            result[i] = chars[half + evenIndex++];
          }
        }
        
        return result.join('');
      }
      
      // ç¼–ç ä¸»å‡½æ•°
      encode(autoId) {
        try {
          // 1. å¼‚æˆ–åŠ å¯†
          const encrypted = autoId ^ this.secretKey;
          
          // 2. Base58 ç¼–ç 
          const base58 = this.toBase58(encrypted);
          
          // 3. å­—ç¬¦æ›¿æ¢
          const substituted = this.substituteChars(base58);
          
          // 4. ä½ç½®æ‰“æ•£
          const scrambled = this.scramblePositions(substituted);
          
          // 5. æ·»åŠ æ ¡éªŒä½
          const checksum = this.calculateChecksum(scrambled);
          const final = scrambled + checksum;
          
          return final;
          
        } catch (error) {
          console.error('ç¼–ç é”™è¯¯:', error);
          return null;
        }
      }
      
      // è§£ç ä¸»å‡½æ•°
      decode(encodedStr) {
        try {
          // 1. éªŒè¯æ ¡éªŒä½
          if (!this.verifyChecksum(encodedStr)) {
            throw new Error('æ ¡éªŒä½éªŒè¯å¤±è´¥');
          }
          
          // 2. ç§»é™¤æ ¡éªŒä½
          const withoutChecksum = encodedStr.slice(0, -1);
          
          // 3. ä½ç½®è¿˜åŸ
          const unscrambled = this.unscramblePositions(withoutChecksum);
          
          // 4. å­—ç¬¦è¿˜åŸ
          const restored = this.restoreChars(unscrambled);
          
          // 5. Base58 è§£ç 
          const base58Decoded = this.fromBase58(restored);
          
          // 6. å¼‚æˆ–è§£å¯†
          const decrypted = base58Decoded ^ this.secretKey;
          
          return decrypted;
          
        } catch (error) {
          console.error('è§£ç é”™è¯¯:', error);
          return null;
        }
      }
    }

    // åˆ›å»ºå…¨å±€ç¼–ç å™¨å®ä¾‹
    const trackingEncoder = new ReversibleEncoder();

    // QR Code generation function
    function createQRCode(elementId, text, size = 170) {
      const element = document.getElementById(elementId);
      element.innerHTML = ''; // Clear existing content
      
      if (!text || text.trim() === '') {
        element.innerHTML = '<p class="text-muted">Enter information above to generate QR code</p>';
        return;
      }
      
      try {
        const qr = qrcode(0, 'M');
        qr.addData(text);
        qr.make();
        
        const qrImage = qr.createImgTag(4, 8);
        element.innerHTML = qrImage;
        
        // Style the QR code
        const img = element.querySelector('img');
        if (img) {
          img.style.width = size + 'px';
          img.style.height = size + 'px';
          img.style.border = '1px solid #ddd';
          img.style.borderRadius = '8px';
          img.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
        }
      } catch (error) {
        element.innerHTML = '<p class="text-danger">Error generating QR code</p>';
        console.error('QR code generation error:', error);
      }
    }

    // WiFi and SMS QR Code generation
    function makeCode() {
      const elText1 = document.getElementById("myInput1");
      const elText2 = document.getElementById("myInput2");
      const elText3 = document.getElementById("myInput3");
      const textnumber = document.getElementById("smsNumber");
      const textcontent = document.getElementById("smsContent");
      
      // WiFi QR Code
      if (elText1 && elText1.value.trim()) {
        const elText = `WIFI:S:${elText1.value};T:${elText2.value};P:${elText3.value};;`;
        createQRCode("qrcode", elText);
      }
      
      // SMS QR Code
      if ((textnumber && textnumber.value.trim()) || (textcontent && textcontent.value.trim())) {
        const smstotal = `smsto:${textnumber.value}:${textcontent.value}`;
        createQRCode("smsCode", smstotal);
      }
    }

    // Web, Tel, and Picture QR Code generation
    function makeCodeweb() {
      const tel = document.getElementById("telinput");
      const web = document.getElementById("webinput");
      const webpic = document.getElementById("webinputpic");
      
      if (web && web.value && web.value !== "https://") {
        createQRCode("qrcodeweb", web.value);
      }
      
      if (webpic && webpic.value) {
        createQRCode("qrcodewebpic", webpic.value);
      }
      
      if (tel && tel.value.trim()) {
        createQRCode("qrcodetel", `tel:${tel.value}`);
      }
    }

    // Generate Image QR Code
    async function generateImageQR() {
      if (uploadedFiles.length === 0) {
        showNotification('Please upload at least one image first!', 'warning');
        return;
      }

      const limit = document.getElementById("limit").value || "100000000";
      const password = document.getElementById("password").value || "1999999927";
      const caption = document.getElementById("caption").value || "Image Gallery";
      const expirationDay = document.getElementById("expiration_day").value || "";
      const expirationTs = document.getElementById("expiration_ts").value || "";

      // Show loading state
      const button = event.target;
      const originalText = button.innerHTML;
      button.innerHTML = '<span class="loading"></span> Generating...';
      button.disabled = true;

      try {
        // Call Cloudflare Worker API to create database entry
        const createHeaders = { 'Content-Type': 'application/json' };
        const jwt = sessionStorage.getItem('maiimg_jwt');
        if (jwt) createHeaders['Authorization'] = 'Bearer ' + jwt;
        const response = await fetch('https://fetch.maipdf.com/api/create-image-link', {
          method: 'POST',
          headers: createHeaders,
          body: JSON.stringify({
            files: uploadedFiles,
            limit: Math.min(parseInt(limit), 99999999),
            password: Math.min(parseInt(password), 99999999),
            caption: caption,
            expiration_day: expirationDay,
            expiration_ts: expirationTs,
            endtime: expirationTs
          })
        });

        const result = await response.json();
        
        if (result.success) {
          // ä½¿ç”¨æ–°çš„å¯é€†å¤æ‚ç¼–ç ç®—æ³•
          const autoId = result.autoId;
          
          // ç”Ÿæˆ Type A (æŸ¥çœ‹é“¾æ¥) - ä¿æŒç®€å•ç¼–ç 
          const identifier = autoId.toString();
          const arr1 = identifier.split('');
          const arrayA = [];
          
          arr1.forEach((digit, i) => {
            let value = parseInt(digit);
            if (value === 0) value = 10;
            arrayA[i] = String.fromCharCode(64 + value); // A=1, B=2, ..., J=10
          });
          
          generatedTypeA = arrayA.join('');
          
          // ç”Ÿæˆ Type B (è¿½è¸ªä»£ç ) - ä½¿ç”¨å¤æ‚ç¼–ç 
          generatedTypeB = trackingEncoder.encode(autoId);
          
          // Update share link input
          const shareLink = `https://maiimg.com/gallery/${generatedTypeA}`;
          document.getElementById("webinputpic").value = shareLink;

          // Update stats display with enhanced information
          document.getElementById("fileCount").textContent = result.fileCount;
          document.getElementById("viewLimit").textContent = result.limit === 100000000 ? 'âˆ' : result.limit.toLocaleString();
          document.getElementById("expirationDisplay").textContent = formatEndtimeDisplay(result.endtime);

          // Update tracking code information in the new enhanced layout
          document.getElementById("btypesay").innerHTML = `
            <div class="insights-intro text-center mb-2">
              These records show when people open your Gallery Link.
            </div>
            <div class="text-center mb-3">
              <div class="tracking-code-display">
                <div class="tracking-code-label">Records Access Code:</div>
                <div class="tracking-code-row">
                  <div class="tracking-code-value">${generatedTypeB}</div>
                  <button class="btn btn-outline-secondary btn-sm tracking-copy-btn" onclick="copyTrackingCode('${generatedTypeB}')">
                    <i class="fas fa-copy me-1"></i>Copy Code
                  </button>
                </div>
              </div>
            </div>
            
            <div class="tracking-info-compact mb-3">
              <div class="gallery-info">
                <i class="fas fa-images me-2"></i>
                <span class="info-text">${result.fileCount} images uploaded</span>
              </div>
            </div>
            
            <div class="text-center">
              <a href="https://maiimg.com/tracking.html?id=${generatedTypeB}" target="_blank" class="btn btn-primary btn-sm">
                <i class="fas fa-external-link-alt me-1"></i>Open Access Records
              </a>
            </div>
            
            <small class="text-muted d-block text-center mt-2">Use this code to view who opened the link and when.</small>
          `;

          // Generate QR code for the share link
          makeCodeweb();

          // Show results section
          document.getElementById("results").style.display = 'block';
          
          // *** å…³é”®ä¿®æ”¹ï¼šç”Ÿæˆé“¾æ¥æˆåŠŸåï¼Œé‡ç½®ä¸Šä¼ ä¼šè¯ ***
          // é‡ç½® dropzone å’Œä¸Šä¼ çŠ¶æ€ï¼Œå‡†å¤‡ä¸‹ä¸€æ¬¡ä¸Šä¼ 
          if (myDropzone) {
            myDropzone.removeAllFiles(true); // æ¸…é™¤æ‰€æœ‰æ–‡ä»¶
          }
          uploadedFiles = []; // æ¸…ç©ºä¸Šä¼ æ–‡ä»¶æ•°ç»„
          currentUploadSessionId = null; // é‡ç½®ä¼šè¯IDï¼Œä¸‹æ¬¡ä¸Šä¼ æ—¶ä¼šç”Ÿæˆæ–°çš„
          
          // æ¸…ç©ºè¡¨å•
          document.getElementById("limit").value = '';
          document.getElementById("password").value = '';
          document.getElementById("caption").value = '';
          const expirationPresetEl = document.getElementById("expiration_preset");
          if (expirationPresetEl) {
            expirationPresetEl.value = '';
          }
          resetExpirationView();
          
          // æ›´æ–°æŒ‰é’®çŠ¶æ€
          updateGenerateButton();
          updateUploadStatus('Ready for new upload session');

          // Scroll to Gallery Link title after layout settles
          setTimeout(() => {
            const galleryLinkTitle = document.getElementById("gallery-link-title");
            const navbar = document.querySelector(".navbar");
            if (galleryLinkTitle) {
              const navHeight = navbar ? navbar.offsetHeight : 0;
              const targetTop = galleryLinkTitle.getBoundingClientRect().top + window.pageYOffset - navHeight - 12;
              window.scrollTo({ top: Math.max(targetTop, 0), behavior: "smooth" });
            }
          }, 80);
          
          showNotification(`âœ… QR code generated successfully! Database ID: ${result.autoId}. Ready for next upload.`, 'success');
          
        } else {
          showNotification('Error creating image link: ' + (result.error || 'Unknown error'), 'error');
        }
      } catch (error) {
        showNotification('Network error creating image link. Please check your connection and try again.', 'error');
      } finally {
        // Restore button state
        button.innerHTML = originalText;
        button.disabled = false;
      }
    }

    // Copy tracking code function
    async function copyTrackingCode(trackingCode) {
      try {
        await navigator.clipboard.writeText(trackingCode);
        showNotification(`âœ… Access code "${trackingCode}" copied to clipboard!`, 'success');
      } catch (err) {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = trackingCode;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showNotification(`âœ… Access code copied to clipboard!`, 'success');
      }
    }

    // Copy function with modern clipboard API
    async function myFunctionpic() {
      const copyText = document.getElementById("webinputpic");
      
      try {
        await navigator.clipboard.writeText(copyText.value);
        document.getElementById("Copied").innerHTML = '<span class="copy-success"><i class="fas fa-check me-1"></i>Copied to clipboard!</span>';
        setTimeout(() => {
          document.getElementById("Copied").innerHTML = "";
        }, 3000);
      } catch (err) {
        // Fallback for older browsers
        copyText.select();
        copyText.setSelectionRange(0, 99999);
        document.execCommand("copy");
        document.getElementById("Copied").innerHTML = '<span class="copy-success"><i class="fas fa-check me-1"></i>Copied!</span>';
        setTimeout(() => {
          document.getElementById("Copied").innerHTML = "";
        }, 3000);
      }
    }

    // Show notification function
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
      notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
      notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      document.body.appendChild(notification);
      
      // Auto dismiss after 5 seconds
      setTimeout(() => {
        if (notification.parentElement) {
          notification.remove();
        }
      }, 5000);
    }

    function hasValidLoginJwt() {
      const jwt = sessionStorage.getItem('maiimg_jwt');
      if (!jwt) return false;
      const parts = jwt.split('.');
      if (parts.length !== 3) return true;
      try {
        const base64 = parts[1].replace(/-/g, '+').replace(/_/g, '/');
        const payload = JSON.parse(atob(base64));
        if (typeof payload.exp === 'number') {
          const active = Date.now() < payload.exp * 1000;
          if (!active) {
            sessionStorage.removeItem('maiimg_jwt');
            sessionStorage.removeItem('maiimg_user');
          }
          return active;
        }
      } catch (error) {
        console.warn('Failed to parse login token for nudge check:', error);
      }
      return true;
    }

    function shouldShowLoginNudge() {
      if (hasValidLoginJwt()) return false;
      const lastShown = Number(localStorage.getItem(LOGIN_NUDGE_KEY) || 0);
      return Date.now() - lastShown >= LOGIN_NUDGE_COOLDOWN_MS;
    }

    function markLoginNudgeShown() {
      localStorage.setItem(LOGIN_NUDGE_KEY, String(Date.now()));
    }

    function showLoginNudgeIfNeeded() {
      if (!shouldShowLoginNudge()) return;
      const nudgeEl = document.getElementById('loginNudgeModal');
      if (!nudgeEl) return;
      markLoginNudgeShown();
      const modal = bootstrap.Modal.getOrCreateInstance(nudgeEl);
      modal.show();
    }

    function formatEndtimeDisplay(endtime) {
      const raw = (endtime ?? '').toString().trim();
      if (!raw) return getTranslation('features.expiration.unlimited', currentLanguage);
      const ts = Number.parseInt(raw, 10);
      if (Number.isNaN(ts) || ts <= 0) return getTranslation('features.expiration.unlimited', currentLanguage);
      return new Date(ts * 1000).toISOString().replace('T', ' ').substring(0, 19) + ' UTC';
    }

    function initExpirationControls() {
      const preset = document.getElementById('expiration_preset');
      const custom = document.getElementById('expiration_custom_days');
      const hidden = document.getElementById('expiration_day');
      const hiddenTs = document.getElementById('expiration_ts');
      const result = document.getElementById('expiration_result');
      const tzSelect = document.getElementById('timezone_tz');
      const tzRow = document.getElementById('timezone_row');
      const localResult = document.getElementById('expiration_local');
      if (!preset || !custom || !hidden || !hiddenTs || !result || !tzSelect || !localResult) return;

      const pad2 = (n) => String(n).padStart(2, '0');
      let lastExpiry = null;
      let userTouchedTz = false;

      const tzData = [
        { id: 'UTC', label: 'UTC' },
        { id: 'Asia/Shanghai', label: 'China (Asia/Shanghai)' },
        { id: 'Asia/Tokyo', label: 'Japan (Asia/Tokyo)' },
        { id: 'Asia/Seoul', label: 'Korea (Asia/Seoul)' },
        { id: 'Asia/Singapore', label: 'Singapore (Asia/Singapore)' },
        { id: 'Asia/Kolkata', label: 'India (Asia/Kolkata)' },
        { id: 'Europe/London', label: 'UK (Europe/London)' },
        { id: 'Europe/Berlin', label: 'Germany (Europe/Berlin)' },
        { id: 'Europe/Paris', label: 'France (Europe/Paris)' },
        { id: 'Asia/Dubai', label: 'UAE (Asia/Dubai)' },
        { id: 'Australia/Sydney', label: 'Australia (Sydney)' },
        { id: 'America/Sao_Paulo', label: 'Brazil (Sao Paulo)' },
        { id: 'Africa/Johannesburg', label: 'South Africa (Johannesburg)' },
        { id: 'Europe/Moscow', label: 'Russia (Moscow)' },
        { id: 'America/Toronto', label: 'Canada (Toronto)' },
        { id: 'America/New_York', label: 'US Eastern (New York)' },
        { id: 'America/Chicago', label: 'US Central (Chicago)' },
        { id: 'America/Denver', label: 'US Mountain (Denver)' },
        { id: 'America/Los_Angeles', label: 'US Pacific (Los Angeles)' },
        { id: 'America/Anchorage', label: 'US Alaska (Anchorage)' },
        { id: 'Pacific/Honolulu', label: 'US Hawaii (Honolulu)' }
      ];

      const buildZoneOptions = () => {
        tzSelect.innerHTML = '';
        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = getTranslation('features.expiration.timezonePlaceholder', currentLanguage);
        tzSelect.appendChild(placeholder);
        tzData.forEach((z) => {
          const opt = document.createElement('option');
          opt.value = z.id;
          opt.textContent = z.label;
          tzSelect.appendChild(opt);
        });
      };

      const formatInTimeZone = (date, timeZone) => {
        try {
          return new Intl.DateTimeFormat('en-US', {
            timeZone,
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
          }).format(date);
        } catch (e) {
          return null;
        }
      };

      const updateLocalTime = () => {
        if (!lastExpiry) {
          localResult.textContent = getTranslation('features.expiration.localNone', currentLanguage);
          return;
        }
        const tzId = tzSelect.value;
        if (!tzId) {
          localResult.textContent = getTranslation('features.expiration.localNone', currentLanguage);
          return;
        }
        const formatted = formatInTimeZone(lastExpiry, tzId);
        if (!formatted) {
          localResult.textContent = getTranslation('features.expiration.localNone', currentLanguage);
          return;
        }
        localResult.textContent = `${getTranslation('features.expiration.localPrefix', currentLanguage)}: ${formatted} (${tzId})`;
      };

      const getOffsetMinutes = (tzId, date) => {
        const parts = new Intl.DateTimeFormat('en-US', {
          timeZone: tzId,
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: false
        }).formatToParts(date);
        const map = {};
        parts.forEach((p) => {
          if (p.type !== 'literal') map[p.type] = p.value;
        });
        const asUTC = Date.UTC(
          Number(map.year),
          Number(map.month) - 1,
          Number(map.day),
          Number(map.hour),
          Number(map.minute),
          Number(map.second)
        );
        return Math.round((asUTC - date.getTime()) / 60000);
      };

      const autoSelectTimeZone = () => {
        let browserTz = '';
        try {
          browserTz = Intl.DateTimeFormat().resolvedOptions().timeZone || '';
        } catch (e) {
          browserTz = '';
        }
        if (browserTz === 'Etc/UTC' || browserTz === 'Etc/GMT' || browserTz === 'GMT' || browserTz.startsWith('UTC') || browserTz.startsWith('GMT')) {
          browserTz = 'UTC';
        }
        const direct = tzData.find((z) => z.id === browserTz);
        if (direct) {
          tzSelect.value = direct.id;
          updateLocalTime();
          return;
        }

        const localOffset = -new Date().getTimezoneOffset();
        let best = null;
        let bestDiff = Infinity;
        tzData.forEach((z) => {
          try {
            const off = getOffsetMinutes(z.id, new Date());
            const diff = Math.abs(off - localOffset);
            if (diff < bestDiff) {
              bestDiff = diff;
              best = z;
            }
          } catch (e) {
            // ignore invalid timezone
          }
        });

        if (best) {
          tzSelect.value = best.id;
          updateLocalTime();
        }
      };

      const hideExpirationExtras = () => {
        result.style.display = 'none';
        tzRow.style.display = 'none';
        localResult.style.display = 'none';
      };

      const updateExpiration = () => {
        const v = preset.value;
        let days = null;

        if (v === '1h') {
          days = 1 / 24;
        } else if (v === '3h') {
          days = 3 / 24;
        } else if (v === '24h') {
          days = 1;
        } else if (v === '5d') {
          days = 5;
        } else if (v === 'custom') {
          const n = parseFloat(custom.value);
          if (!Number.isNaN(n) && n > 0) {
            days = n;
          }
        }

        if (v === 'custom') {
          custom.style.display = 'block';
        } else {
          custom.style.display = 'none';
          custom.value = '';
        }

        if (v === 'unlimited') {
          hidden.value = '';
          hiddenTs.value = '';
          result.textContent = getTranslation('features.expiration.utcUnlimited', currentLanguage);
          lastExpiry = null;
          result.style.display = '';
          tzRow.style.display = 'none';
          localResult.style.display = 'none';
          updateLocalTime();
          return;
        }

        if (days === null) {
          hidden.value = '';
          hiddenTs.value = '';
          result.textContent = getTranslation('features.expiration.utcNone', currentLanguage);
          lastExpiry = null;
          hideExpirationExtras();
          updateLocalTime();
          return;
        }

        hidden.value = String(days);
        const now = new Date();
        const expiry = new Date(now.getTime() + days * 24 * 60 * 60 * 1000);
        lastExpiry = expiry;
        hiddenTs.value = String(Math.floor(expiry.getTime() / 1000));
        const utcText = `${expiry.getUTCFullYear()}-${pad2(expiry.getUTCMonth() + 1)}-${pad2(expiry.getUTCDate())} ${pad2(expiry.getUTCHours())}:${pad2(expiry.getUTCMinutes())}:${pad2(expiry.getUTCSeconds())} UTC`;
        result.textContent = `${getTranslation('features.expiration.utcPrefix', currentLanguage)}: ${utcText}`;
        result.style.display = '';
        tzRow.style.display = 'block';
        localResult.style.display = '';
        if (!userTouchedTz) {
          autoSelectTimeZone();
        } else {
          updateLocalTime();
        }
      };

      preset.addEventListener('change', updateExpiration);
      custom.addEventListener('input', updateExpiration);
      tzSelect.addEventListener('change', () => {
        userTouchedTz = true;
        updateLocalTime();
      });

      buildZoneOptions();
      hideExpirationExtras();
      updateExpiration();
      window.__updateMaiimgExpiration = updateExpiration;
    }

    function resetExpirationView() {
      const customEl = document.getElementById('expiration_custom_days');
      const dayEl = document.getElementById('expiration_day');
      const tsEl = document.getElementById('expiration_ts');
      const resultEl = document.getElementById('expiration_result');
      const localEl = document.getElementById('expiration_local');
      const tzRowEl = document.getElementById('timezone_row');
      if (customEl) customEl.value = '';
      if (dayEl) dayEl.value = '';
      if (tsEl) tsEl.value = '';
      if (resultEl) {
        resultEl.textContent = getTranslation('features.expiration.utcNone', currentLanguage);
        resultEl.style.display = 'none';
      }
      if (localEl) {
        localEl.textContent = getTranslation('features.expiration.localNone', currentLanguage);
        localEl.style.display = 'none';
      }
      if (tzRowEl) tzRowEl.style.display = 'none';
      if (typeof window.__updateMaiimgExpiration === 'function') {
        window.__updateMaiimgExpiration();
      }
    }

    // Update button state based on form validation and uploaded files
    function updateGenerateButton() {
      const generateBtn = document.getElementById('generateBtn');
      const generateBtnStatus = document.getElementById('generateBtnStatus');
      const limitInput = document.getElementById('limit');
      const passwordInput = document.getElementById('password');
      const captionInput = document.getElementById('caption');
      
      // Check if all required fields are filled
      const hasLimit = limitInput.value.trim() !== '';
      const hasPassword = passwordInput.value.trim() !== '';
      const hasCaption = captionInput.value.trim() !== '';
      const hasFiles = uploadedFiles.length > 0;
      
      // Enable button only if all conditions are met
      if (hasLimit && hasPassword && hasCaption && hasFiles) {
        generateBtn.disabled = false;
        generateBtnStatus.textContent = 'Ready to generate QR code!';
        generateBtnStatus.className = 'text-success';
      } else {
        generateBtn.disabled = true;
        
        // Show specific missing requirements
        const missing = [];
        if (!hasLimit) missing.push('View limit');
        if (!hasPassword) missing.push('Time control');
        if (!hasCaption) missing.push('Description');
        if (!hasFiles) missing.push('Upload images');
        
        generateBtnStatus.textContent = `Missing: ${missing.join(', ')}`;
        generateBtnStatus.className = 'text-muted';
      }
    }

    // Update upload status function
    function updateUploadStatus(message) {
      const statusElement = document.getElementById('pleaseupload');
      if (statusElement) {
        statusElement.textContent = message;
      }
    }

    // ç”Ÿæˆæ–°çš„ä¸Šä¼ ä¼šè¯ID
    function generateUploadSessionId() {
      return 'img_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // Initialize Dropzone for image upload
    document.addEventListener('DOMContentLoaded', function() {
      // Disable auto discovery
      Dropzone.autoDiscover = false;
      
      // ä¸åœ¨é¡µé¢åŠ è½½æ—¶ç”Ÿæˆä¼šè¯IDï¼Œæ”¹ä¸ºåœ¨ç¬¬ä¸€æ¬¡ä¸Šä¼ æ—¶ç”Ÿæˆ
      initExpirationControls();

      const dropzEl = document.getElementById('dropz');
      if (dropzEl) {
        dropzEl.addEventListener('click', () => {
          setTimeout(showLoginNudgeIfNeeded, 120);
        }, true);
      }
      
      myDropzone = new Dropzone("#dropz", {
        url: "https://fetch.maipdf.com/api/upload-image",
        method: "post",
        paramName: "file",
        maxFiles: 25,
        maxFilesize: 50, // 50MB
        acceptedFiles: ".png,.jpg,.jpeg,.gif,.webp,image/*",
        addRemoveLinks: true,
        parallelUploads: 3,
        clickable: true, // ç¡®ä¿å¯ä»¥ç‚¹å‡»
        createImageThumbnails: true, // å¯ç”¨ç¼©ç•¥å›¾
        dictDefaultMessage: '<i class="fas fa-cloud-upload-alt upload-icon"></i><div class="upload-text">Drop images here or click to upload</div><div class="upload-subtext">Supports: PNG, JPG, JPEG, GIF, WebP â€¢ Max 50MB each â€¢ Up to 25 files</div>',
        dictMaxFilesExceeded: "Maximum 25 files allowed!",
        dictResponseError: 'Upload failed!',
        dictInvalidFileType: "Only image files are allowed.",
        dictFallbackMessage: "Your browser does not support drag and drop uploads.",
        dictFileTooBig: "File is too big ({{filesize}}MB). Max filesize: {{maxFilesize}}MB.",
        dictRemoveFile: "Remove file",
        dictCancelUpload: "Cancel upload",
        timeout: 300000, // 5 minutes timeout
        
        init: function() {
          const dropzone = this;
          if (this.hiddenFileInput) {
            this.hiddenFileInput.addEventListener('click', () => {
              setTimeout(showLoginNudgeIfNeeded, 120);
            }, true);
          }
          
          this.on("addedfile", function(file) {
            setTimeout(showLoginNudgeIfNeeded, 250);
            // åœ¨æ·»åŠ ç¬¬ä¸€ä¸ªæ–‡ä»¶æ—¶ç”Ÿæˆä¼šè¯IDï¼ˆå¦‚æœè¿˜æ²¡æœ‰çš„è¯ï¼‰
            if (!currentUploadSessionId) {
              currentUploadSessionId = generateUploadSessionId();
              console.log(`New upload session started: ${currentUploadSessionId}`);
            }
            
            updateUploadStatus(`Added: ${file.name} (Session: ${currentUploadSessionId})`);
            console.log(`File added: ${file.name}, Session ID: ${currentUploadSessionId}`);
          });
          
          this.on("sending", function(file, xhr, formData) {
            updateUploadStatus(`Uploading: ${file.name}...`);
            
            // ç¡®ä¿ä½¿ç”¨å½“å‰ä¼šè¯ID
            if (!currentUploadSessionId) {
              currentUploadSessionId = generateUploadSessionId();
            }
            
            // é€šè¿‡è¯·æ±‚å¤´å‘é€ä¼šè¯IDï¼ˆåç«¯APIä»è¯·æ±‚å¤´ä¸­è¯»å–ï¼‰
            xhr.setRequestHeader('X-Upload-Session-Id', currentUploadSessionId);
            console.log(`Uploading file: ${file.name} with Session ID: ${currentUploadSessionId}`);
          });
          
          this.on("success", function(file, response) {
            try {
              const result = typeof response === 'string' ? JSON.parse(response) : response;
              
              if (result.success) {
                // Add to uploaded files array with all necessary fields
                uploadedFiles.push({
                  filename: result.filename,
                  originalName: file.name,
                  size: file.size,
                  url: result.url,
                  directory: result.directory || currentUploadSessionId,
                  uploadSessionId: currentUploadSessionId
                });
                
                updateUploadStatus(`âœ… Uploaded: ${file.name} (Folder: ${result.directory || currentUploadSessionId})`);
                updateGenerateButton(); // Update button state when files are uploaded
                
                console.log(`File uploaded successfully: ${file.name}, Directory: ${result.directory || currentUploadSessionId}`);
                
              } else {
                updateUploadStatus(`âŒ Failed: ${file.name} - ${result.error}`);
              }
            } catch (error) {
              updateUploadStatus(`âŒ Error processing: ${file.name}`);
              console.error('Error processing upload response:', error);
            }
          });
          
          this.on("error", function(file, errorMessage) {
            updateUploadStatus(`âŒ Error: ${file.name} - ${errorMessage}`);
            console.error(`Upload error for ${file.name}:`, errorMessage);
          });
          
          this.on("removedfile", function(file) {
            // Remove from uploaded files array
            uploadedFiles = uploadedFiles.filter(f => f.originalName !== file.name);
            updateUploadStatus(`Removed: ${file.name}`);
            updateGenerateButton(); // Update button state when files are removed
            console.log(`File removed: ${file.name}, Remaining files: ${uploadedFiles.length}`);
            
            // å¦‚æœæ‰€æœ‰æ–‡ä»¶éƒ½è¢«åˆ é™¤äº†ï¼Œé‡ç½®ä¼šè¯ID
            if (uploadedFiles.length === 0) {
              currentUploadSessionId = null;
              updateUploadStatus('Ready for new upload session');
            }
          });
          
          this.on("queuecomplete", function() {
            if (uploadedFiles.length > 0) {
              updateUploadStatus(`Ready! ${uploadedFiles.length} files uploaded to folder: ${currentUploadSessionId}`);
            } else {
              updateUploadStatus('Ready for new upload session');
            }
            console.log(`Upload queue complete. Total files: ${uploadedFiles.length}, Session ID: ${currentUploadSessionId}`);
          });
          
          this.on("reset", function() {
            // å½“ dropzone é‡ç½®æ—¶ï¼Œä¸ç«‹å³ç”Ÿæˆæ–°çš„ session ID
            currentUploadSessionId = null;
            uploadedFiles = [];
            updateUploadStatus('Upload area reset - ready for new images');
            console.log(`Dropzone reset. Session ID cleared.`);
          });
        }
      });

      // Add real-time validation listeners
      ['limit', 'password', 'caption', 'expiration_preset', 'expiration_custom_days'].forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.addEventListener('input', updateGenerateButton);
          field.addEventListener('blur', updateGenerateButton);
          field.addEventListener('change', updateGenerateButton);
        }
      });

      // WiFi form listeners
      ["myInput1", "myInput2", "myInput3"].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener("input", makeCode);
          element.addEventListener("keydown", function(e) {
            if (e.key === 'Enter') makeCode();
          });
        }
      });

      // SMS form listeners
      ["smsNumber", "smsContent"].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener("input", makeCode);
          element.addEventListener("keydown", function(e) {
            if (e.key === 'Enter') makeCode();
          });
        }
      });

      // Other form listeners
      ["webinput", "telinput"].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener("input", makeCodeweb);
          element.addEventListener("keydown", function(e) {
            if (e.key === 'Enter') makeCodeweb();
          });
        }
      });

      // Initialize empty QR codes
      createQRCode("qrcode", "");
      createQRCode("smsCode", "");
      createQRCode("qrcodeweb", "");
      createQRCode("qrcodetel", "");
      createQRCode("qrcodewebpic", "");

      // Initial button state check
      updateGenerateButton();

      // Initialize translations
      initializeTranslations();
      updateFooterComplianceText(window.i18n ? window.i18n.currentLanguage : currentLanguage);
      syncMobileLanguageFlag(window.i18n ? window.i18n.currentLanguage : currentLanguage);
      
      // Load saved language preference
      const savedLanguage = localStorage.getItem('preferred-language');
      const supportedLanguages = ['en', 'zh', 'tw', 'ja', 'de', 'ko', 'fr', 'it'];
      if (savedLanguage && supportedLanguages.includes(savedLanguage)) {
        changeLanguage(savedLanguage);
      }

      // Smooth scrolling for navigation links
      document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
          e.preventDefault();
          const href = this.getAttribute('href');
          if (href && href !== '#') {
            const target = document.querySelector(href);
            if (target) {
              target.scrollIntoView({ behavior: 'smooth' });
            }
          }
        });
      });

      const nudgeSignInBtn = document.getElementById('loginNudgeSignInBtn');
      if (nudgeSignInBtn) {
        nudgeSignInBtn.addEventListener('click', () => {
          const nudge = bootstrap.Modal.getInstance(document.getElementById('loginNudgeModal'));
          if (nudge) nudge.hide();
          const loginModalEl = document.getElementById('loginModal');
          if (loginModalEl) {
            const loginModal = bootstrap.Modal.getOrCreateInstance(loginModalEl);
            loginModal.show();
          }
        });
      }
    });
  </script>

  <!-- Firebase Authentication -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
    import {
      getAuth, signInWithPopup, signOut, onAuthStateChanged,
      GoogleAuthProvider,
      signInWithEmailAndPassword, createUserWithEmailAndPassword,
      sendPasswordResetEmail, sendEmailVerification
    } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA-Y2zgMaXR08CYjS3HrucYi9xlcMr2_wQ",
      authDomain: "maipdf-login.firebaseapp.com",
      projectId: "maipdf-login",
      storageBucket: "maipdf-login.firebasestorage.app",
      messagingSenderId: "150464233488",
      appId: "1:150464233488:web:b365ab4e4a52eca157ca95",
      measurementId: "G-997G0FQK2H"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const googleProvider = new GoogleAuthProvider();
    googleProvider.setCustomParameters({ prompt: "select_account" });

    const WORKER_API = 'https://fetch.maipdf.com';
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const userInfoEl = document.getElementById("userInfo");
    const dashboardBtn = document.getElementById("dashboardBtn");
    const mobileLoginBtn = document.getElementById("mobileLoginBtn");
    const mobileLogoutBtn = document.getElementById("mobileLogoutBtn");
    const mobileDashboardBtn = document.getElementById("mobileDashboardBtn");
    const mobileUserEmail = document.getElementById("mobileUserEmail");

    function syncAuthUI(user, allowAccess) {
      if (allowAccess) {
        const name = user?.email || user?.displayName || "User";
        loginBtn.classList.add("d-none");
        logoutBtn.classList.remove("d-none");
        userInfoEl.classList.remove("d-none");
        dashboardBtn.classList.remove("d-none");
        userInfoEl.textContent = name;

        mobileLoginBtn.classList.add("d-none");
        mobileLogoutBtn.classList.remove("d-none");
        mobileDashboardBtn.classList.remove("d-none");
        mobileUserEmail.textContent = name;
      } else {
        loginBtn.classList.remove("d-none");
        logoutBtn.classList.add("d-none");
        userInfoEl.classList.add("d-none");
        dashboardBtn.classList.add("d-none");
        userInfoEl.textContent = "";

        mobileLoginBtn.classList.remove("d-none");
        mobileLogoutBtn.classList.add("d-none");
        mobileDashboardBtn.classList.add("d-none");
        mobileUserEmail.textContent = "Guest";
      }
    }

    // View elements
    const views = {
      signIn: document.getElementById("authSignIn"),
      signUp: document.getElementById("authSignUp"),
      forgot: document.getElementById("authForgotPassword"),
      verify: document.getElementById("authVerifyEmail"),
      success: document.getElementById("authSuccess")
    };
    const modalTitle = document.getElementById("authModalTitle");
    const authError = document.getElementById("authError");

    function t(key) {
      if (window.i18n) return window.i18n.t(key);
      const fallbacks = { 'auth.signInTitle': 'Sign in to MaiIMG', 'auth.createAccount': 'Create Account', 'auth.resetTitle': 'Reset Password', 'auth.verifyTitle': 'Verify Email' };
      return fallbacks[key] || key;
    }

    function showView(name) {
      Object.values(views).forEach(v => v.classList.add("d-none"));
      authError.classList.add("d-none");
      views[name].classList.remove("d-none");
      const titleKeys = { signIn: "auth.signInTitle", signUp: "auth.createAccount", forgot: "auth.resetTitle", verify: "auth.verifyTitle", success: "" };
      modalTitle.textContent = titleKeys[name] ? t(titleKeys[name]) : "";
    }

    function showError(msg) {
      authError.textContent = msg;
      authError.classList.remove("d-none");
      setTimeout(() => authError.classList.add("d-none"), 6000);
    }

    function dismissModal() {
      const m = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
      if (m) m.hide();
    }

    function showSuccess(msg) {
      document.getElementById("authSuccessMsg").textContent = msg;
      showView("success");
      setTimeout(dismissModal, 2000);
    }

    // Reset to sign-in view when modal opens
    document.getElementById('loginModal').addEventListener('show.bs.modal', () => showView("signIn"));

    // View switching
    document.getElementById("showSignUp").addEventListener("click", (e) => { e.preventDefault(); showView("signUp"); });
    document.getElementById("showSignIn").addEventListener("click", (e) => { e.preventDefault(); showView("signIn"); });
    document.getElementById("showForgotPassword").addEventListener("click", (e) => { e.preventDefault(); showView("forgot"); });
    document.getElementById("backToSignIn").addEventListener("click", (e) => { e.preventDefault(); showView("signIn"); });

    // Worker D1 auth
    async function workerAuth(email, uid) {
      try {
        await fetch(`${WORKER_API}/api/user/register`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, uid })
        });
        const res = await fetch(`${WORKER_API}/api/user/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, uid })
        });
        const data = await res.json();
        if (data.token) {
          sessionStorage.setItem("maiimg_jwt", data.token);
          sessionStorage.setItem("maiimg_user", JSON.stringify({
            email: data.email, balance: data.balance, plan: data.plan
          }));
        }
        return data;
      } catch (err) {
        console.error("Worker auth error:", err);
        return null;
      }
    }

    // --- Google Login ---
    document.getElementById("googleLoginBtn").addEventListener("click", async () => {
      try {
        await signInWithPopup(auth, googleProvider);
        dismissModal();
      } catch (error) {
        showError(error.message);
      }
    });

    // --- Email Sign In ---
    document.getElementById("emailLoginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("loginEmail").value;
      const pw = document.getElementById("loginPassword").value;
      try {
        const cred = await signInWithEmailAndPassword(auth, email, pw);
        if (!cred.user.emailVerified) {
          showView("verify");
          document.getElementById("verifyEmailAddr").textContent = email;
          return;
        }
        dismissModal();
      } catch (error) {
        const msg = {
          'auth/invalid-credential': t('auth.invalidCredential'),
          'auth/user-not-found': t('auth.userNotFound'),
          'auth/wrong-password': t('auth.wrongPassword'),
          'auth/too-many-requests': t('auth.tooManyRequests')
        }[error.code] || error.message;
        showError(msg);
      }
    });

    // --- Email Sign Up ---
    document.getElementById("emailSignUpForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("signUpEmail").value;
      const pw = document.getElementById("signUpPassword").value;
      const pw2 = document.getElementById("signUpPasswordConfirm").value;
      if (pw !== pw2) { showError(t('auth.passwordsNoMatch')); return; }
      if (pw.length < 6) { showError(t('auth.passwordTooShort')); return; }
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, pw);
        await sendEmailVerification(cred.user);
        showView("verify");
        document.getElementById("verifyEmailAddr").textContent = email;
      } catch (error) {
        const msg = {
          'auth/email-already-in-use': t('auth.emailInUse'),
          'auth/weak-password': t('auth.weakPassword'),
          'auth/invalid-email': t('auth.invalidEmail')
        }[error.code] || error.message;
        showError(msg);
      }
    });

    // --- Forgot Password ---
    document.getElementById("forgotPasswordForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("resetEmail").value;
      try {
        await sendPasswordResetEmail(auth, email);
        showSuccess(t('auth.resetSent'));
      } catch (error) {
        const msg = error.code === 'auth/user-not-found' ? t('auth.userNotFound') : error.message;
        showError(msg);
      }
    });

    // --- Resend Verification ---
    document.getElementById("resendVerification").addEventListener("click", async () => {
      if (auth.currentUser) {
        try {
          await sendEmailVerification(auth.currentUser);
          showError(""); // clear
          document.getElementById("resendVerification").textContent = t('auth.emailSent');
          setTimeout(() => { document.getElementById("resendVerification").textContent = t('auth.resendVerification'); }, 3000);
        } catch (error) {
          showError(error.code === 'auth/too-many-requests' ? t('auth.waitBeforeResend') : error.message);
        }
      }
    });

    // --- "I've Verified" button ---
    document.getElementById("verificationDone").addEventListener("click", async () => {
      if (auth.currentUser) {
        await auth.currentUser.reload();
        if (auth.currentUser.emailVerified) {
          dismissModal();
        } else {
          showError(t('auth.emailNotVerified'));
        }
      }
    });

    // --- Logout ---
    async function doLogout() {
      try {
        await signOut(auth);
        sessionStorage.removeItem("maiimg_jwt");
        sessionStorage.removeItem("maiimg_user");
        location.reload();
      } catch (error) {
        console.error("Logout failed:", error);
      }
    }

    logoutBtn.addEventListener("click", doLogout);
    mobileLogoutBtn.addEventListener("click", doLogout);

    // --- Auth State ---
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        // Google users are auto-verified; email users must verify
        if (!user.emailVerified && user.providerData[0]?.providerId === 'password') {
          syncAuthUI(null, false);
          return;
        }
        syncAuthUI(user, true);

        await workerAuth(user.email || user.providerData[0]?.email || user.uid, user.uid);
      } else {
        syncAuthUI(null, false);
      }
    });
  </script>
</body>
</html>
