<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracking Code Decoder - Gallery Access Logs</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="alternate icon" type="image/x-icon" href="favicon.ico">
    <link rel="shortcut icon" type="image/svg+xml" href="favicon.svg">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #6366f1;
            --secondary-color: #06b6d4;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --dark-color: #1f2937;
            --light-bg: #f8fafc;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem 0;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .header-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
            border-top: 4px solid var(--primary-color);
        }

        .content-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .form-control {
            border-radius: 12px;
            border: 2px solid #e5e7eb;
            padding: 14px 18px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .btn {
            border-radius: 12px;
            padding: 14px 28px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(99, 102, 241, 0.4);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .stat-card {
            background: var(--light-bg);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .access-log-table {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .table {
            margin-bottom: 0;
        }

        .table thead th {
            background: var(--primary-color);
            color: white;
            border: none;
            font-weight: 600;
            padding: 1rem;
        }

        .table tbody td {
            padding: 1rem;
            border-color: #e5e7eb;
            vertical-align: middle;
        }

        .table tbody tr:hover {
            background-color: var(--light-bg);
        }

        .gallery-info {
            background: linear-gradient(135deg, #ecfdf5, #d1fae5);
            border: 2px solid var(--success-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .alert {
            border-radius: 12px;
            border: none;
            padding: 1rem 1.5rem;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .ip-flag {
            width: 20px;
            height: 15px;
            margin-right: 0.5rem;
        }

        .browser-icon {
            width: 16px;
            height: 16px;
            margin-right: 0.5rem;
        }

        .decode-result {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 12px;
            padding: 1rem;
            margin: 1rem 0;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        /* Language Selector Styles */
        .language-selector .dropdown-toggle {
            background: rgba(255, 255, 255, 0.9) !important;
            border: 2px solid var(--primary-color) !important;
            color: var(--primary-color) !important;
            font-weight: 600 !important;
            padding: 8px 16px !important;
            border-radius: 12px !important;
            transition: all 0.3s ease !important;
            display: flex !important;
            align-items: center !important;
            gap: 8px !important;
            min-width: 120px !important;
        }

        .language-selector .dropdown-toggle:hover,
        .language-selector .dropdown-toggle:focus {
            background: var(--primary-color) !important;
            color: white !important;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1) !important;
        }

        .language-selector .dropdown-menu {
            background: white !important;
            border: 1px solid #e5e7eb !important;
            border-radius: 12px !important;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15) !important;
            padding: 8px 0 !important;
            min-width: 140px !important;
        }

        .language-selector .dropdown-item {
            padding: 10px 16px !important;
            color: #374151 !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            transition: all 0.2s ease !important;
            display: flex !important;
            align-items: center !important;
            gap: 8px !important;
        }

        .language-selector .dropdown-item:hover {
            background: linear-gradient(135deg, #f8faff, #eef2ff) !important;
            color: var(--primary-color) !important;
        }

        .flag-icon {
            font-size: 1.3rem !important;
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 0 0.5rem;
            }
            
            .content-card {
                padding: 1rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }
            
            .table-responsive {
                font-size: 0.875rem;
            }
            
            .language-selector .dropdown-toggle {
                min-width: 100px !important;
                font-size: 13px !important;
            }
        }
    </style>
</head>

<body>
    <div class="main-container">
        <!-- Header -->
        <div class="header-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h1 class="display-5 fw-bold mb-0">
                    <i class="fas fa-search text-primary me-2"></i>
                    <span data-translate="header.title">Tracking Code Decoder</span>
                </h1>
                
                <!-- Language Selector -->
                <div class="language-selector">
                    <div class="dropdown">
                        <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" id="languageDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <span id="currentLanguageFlag">üá∫üá∏</span>
                            <span id="currentLanguageName" data-translate="language.english">English</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="languageDropdown">
                            <li>
                                <a class="dropdown-item" href="#" onclick="changeTrackingLanguage('en')">
                                    <span class="flag-icon">üá∫üá∏</span>
                                    <span data-translate="language.english">English</span>
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#" onclick="changeTrackingLanguage('zh')">
                                    <span class="flag-icon">üá®üá≥</span>
                                    <span data-translate="language.chinese">‰∏≠Êñá</span>
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#" onclick="changeTrackingLanguage('tw')">
                                    <span class="flag-icon">üáπüáº</span>
                                    <span data-translate="language.taiwan">‰∏≠ËèØÊ∞ëÂúã</span>
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#" onclick="changeTrackingLanguage('ja')">
                                    <span class="flag-icon">üáØüáµ</span>
                                    <span data-translate="language.japanese">Êó•Êú¨Ë™û</span>
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#" onclick="changeTrackingLanguage('de')">
                                    <span class="flag-icon">üá©üá™</span>
                                    <span data-translate="language.german">Deutsch</span>
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#" onclick="changeTrackingLanguage('ko')">
                                    <span class="flag-icon">üá∞üá∑</span>
                                    <span data-translate="language.korean">ÌïúÍµ≠Ïñ¥</span>
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#" onclick="changeTrackingLanguage('fr')">
                                    <span class="flag-icon">üá´üá∑</span>
                                    <span data-translate="language.french">Fran√ßais</span>
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#" onclick="changeTrackingLanguage('it')">
                                    <span class="flag-icon">üáÆüáπ</span>
                                    <span data-translate="language.italian">Italiano</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <p class="lead text-muted mb-0" data-translate="header.subtitle">
                Enter tracking code to view corresponding gallery access logs
            </p>
        </div>

        <!-- Decoder Form -->
        <div class="content-card">
            <h3 class="fw-bold mb-4">
                <i class="fas fa-code me-2"></i>
                <span data-translate="decoder.title">Decode Tracking Code</span>
            </h3>
            
            <div class="row">
                <div class="col-md-8">
                    <div class="mb-3">
                        <label for="trackingCode" class="form-label fw-semibold">
                            <i class="fas fa-key me-1"></i><span data-translate="decoder.trackingCodeLabel">Tracking Code</span>
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="trackingCode" 
                               data-translate-placeholder="decoder.trackingCodePlaceholder"
                               placeholder="Enter complex encoded tracking code (e.g., XgaLrs)" 
                               maxlength="50">
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            <span data-translate="decoder.trackingCodeHelp">This is the complex encoded string obtained from QR generation results</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-semibold">&nbsp;</label>
                    <button type="button" 
                            class="btn btn-primary w-100" 
                            onclick="decodeAndQuery()"
                            id="decodeBtn">
                        <i class="fas fa-search me-2"></i>
                        <span data-translate="decoder.decodeButton">Decode & Query</span>
                    </button>
                </div>
            </div>

            <!-- Decode Result -->
            <div id="decodeResult" style="display: none;">
                <div class="decode-result">
                    <h6 class="fw-bold mb-2">
                        <i class="fas fa-unlock me-1"></i>Decode Result
                    </h6>
                    <div id="decodedInfo"></div>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden" data-translate="loading.loading">Loading...</span>
            </div>
            <p class="mt-3 text-muted" data-translate="loading.queryingLogs">Querying access logs...</p>
        </div>

        <!-- Gallery Information -->
        <div class="content-card" id="galleryInfoCard" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold mb-0">
                    <i class="fas fa-images me-2"></i>
                    <span data-translate="gallery.title">Gallery Information</span>
                </h3>
                <button type="button" 
                        class="btn btn-danger btn-sm" 
                        onclick="showDeleteConfirmation()"
                        id="deleteGalleryBtn">
                    <i class="fas fa-trash me-1"></i>
                    <span data-translate="delete.button">Delete Gallery</span>
                </button>
            </div>
            <div class="gallery-info" id="galleryInfo">
                <!-- Gallery info will be populated here -->
            </div>
        </div>

        <!-- Statistics -->
        <div class="content-card" id="statisticsCard" style="display: none;">
            <h3 class="fw-bold mb-4">
                <i class="fas fa-chart-bar me-2"></i>
                <span data-translate="statistics.title">Access Statistics</span>
            </h3>
            <div class="stats-grid" id="statsGrid">
                <!-- Stats will be populated here -->
            </div>
        </div>

        <!-- Access Logs -->
        <div class="content-card" id="accessLogsCard" style="display: none;">
            <h3 class="fw-bold mb-4">
                <i class="fas fa-list me-2"></i>
                <span data-translate="accessLogs.title">Access Logs</span>
                <span class="badge bg-primary ms-2" id="logCount">0</span>
            </h3>
            
            <div class="table-responsive access-log-table">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th><i class="fas fa-clock me-1"></i><span data-translate="accessLogs.accessTime">Access Time</span></th>
                            <th><i class="fas fa-map-marker-alt me-1"></i><span data-translate="accessLogs.ipAddress">IP Address</span></th>
                            <th><i class="fas fa-desktop me-1"></i><span data-translate="accessLogs.browser">Browser</span></th>
                            <th><i class="fas fa-link me-1"></i><span data-translate="accessLogs.referrer">Referrer</span></th>
                        </tr>
                    </thead>
                    <tbody id="accessLogsBody">
                        <!-- Access logs will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Error Card -->
        <div class="content-card" id="errorCard" style="display: none;">
            <div class="alert alert-danger">
                <h5 class="alert-heading">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span data-translate="errors.title">Query Failed</span>
                </h5>
                <p class="mb-0" id="errorMessage"></p>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Confirm Gallery Deletion
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-warning me-2"></i>
                        <strong>Warning:</strong> This action will set the view count to 0, effectively "deleting" the gallery access.
                    </div>
                    
                    <div class="mb-3">
                        <h6>Gallery Details:</h6>
                        <div id="deleteConfirmDetails">
                            <!-- Gallery details will be populated here -->
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="confirmCodeInput" class="form-label">
                            <strong>Type the confirmation code to proceed:</strong>
                        </label>
                        <div class="input-group">
                            <span class="input-group-text bg-danger text-white">
                                <i class="fas fa-key"></i>
                            </span>
                            <input type="text" 
                                   class="form-control" 
                                   id="confirmCodeInput" 
                                   placeholder="Enter confirmation code here"
                                   autocomplete="off">
                        </div>
                        <div class="form-text">
                            Confirmation code: <code id="expectedConfirmCode">DELETE-XXX</code>
                        </div>
                    </div>
                    
                    <div class="text-muted small">
                        <i class="fas fa-info-circle me-1"></i>
                        This operation will:
                        <ul class="mt-2 mb-0">
                            <li>Set the gallery view count to 0</li>
                            <li>Prevent further access to the gallery</li>
                            <li>Log this deletion operation</li>
                            <li>Cannot be undone through this interface</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                    <button type="button" class="btn btn-danger" onclick="executeDelete()" id="executeDeleteBtn">
                        <i class="fas fa-trash me-1"></i>Delete Gallery
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <!-- Internationalization -->
    <script src="tracking-i18n.js"></script>
    <script>
        // Reversible complex encoding system (same algorithm as QR page)
        class ReversibleEncoder {
            constructor() {
                // Custom character set (avoiding confusing characters 0, O, 1, I, l)
                this.charset = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789abcdefghjkmnpqrstuvwxyz';
                this.base = this.charset.length; // 58
                
                // Fixed secret key (keep consistent with encoder)
                this.secretKey = 0x5A5A5A5A; // XOR key
                
                // Character substitution mapping (increase complexity)
                this.charMap = {
                    'A': 'X', 'B': 'Y', 'C': 'Z', 'D': 'a', 'E': 'b',
                    'F': 'c', 'G': 'd', 'H': 'e', 'J': 'f', 'K': 'g',
                    'L': 'h', 'M': 'j', 'N': 'k', 'P': 'm', 'Q': 'n',
                    'R': 'p', 'S': 'q', 'T': 'r', 'U': 's', 'V': 't',
                    'W': 'u', 'X': 'v', 'Y': 'w', 'Z': 'x', '2': 'y',
                    '3': 'z', '4': 'A', '5': 'B', '6': 'C', '7': 'D',
                    '8': 'E', '9': 'F', 'a': 'G', 'b': 'H', 'c': 'J',
                    'd': 'K', 'e': 'L', 'f': 'M', 'g': 'N', 'h': 'P',
                    'j': 'Q', 'k': 'R', 'm': 'S', 'n': 'T', 'p': 'U',
                    'q': 'V', 'r': 'W', 's': '2', 't': '3', 'u': '4',
                    'v': '5', 'w': '6', 'x': '7', 'y': '8', 'z': '9'
                };
                
                // Reverse mapping
                this.reverseCharMap = {};
                for (let [key, value] of Object.entries(this.charMap)) {
                    this.reverseCharMap[value] = key;
                }
            }
            
            // Calculate checksum
            calculateChecksum(str) {
                let sum = 0;
                for (let i = 0; i < str.length; i++) {
                    sum += str.charCodeAt(i) * (i + 1);
                }
                return this.charset[sum % this.base];
            }
            
            // Verify checksum
            verifyChecksum(str) {
                if (str.length < 2) return false;
                const checksum = str[str.length - 1];
                const data = str.slice(0, -1);
                return this.calculateChecksum(data) === checksum;
            }
            
            // Base58 decode
            fromBase58(str) {
                let result = 0;
                let power = 1;
                
                for (let i = str.length - 1; i >= 0; i--) {
                    const index = this.charset.indexOf(str[i]);
                    if (index === -1) throw new Error('Invalid character in encoded string');
                    result += index * power;
                    power *= this.base;
                }
                return result;
            }
            
            // Character restoration
            restoreChars(str) {
                return str.split('').map(char => this.reverseCharMap[char] || char).join('');
            }
            
            // Position restoration
            unscramblePositions(str) {
                const chars = str.split('');
                const result = new Array(chars.length);
                const half = Math.ceil(chars.length / 2);
                
                let oddIndex = 0, evenIndex = 0;
                
                for (let i = 0; i < chars.length; i++) {
                    if (i % 2 === 1) {
                        result[i] = chars[oddIndex++];
                    } else {
                        result[i] = chars[half + evenIndex++];
                    }
                }
                
                return result.join('');
            }
            
            // Main decode function
            decode(encodedStr) {
                try {
                    console.log('üîÑ Starting decode, encoded string:', encodedStr);
                    
                    // 1. Verify checksum
                    if (!this.verifyChecksum(encodedStr)) {
                        throw new Error('Checksum verification failed');
                    }
                    
                    // 2. Remove checksum
                    const withoutChecksum = encodedStr.slice(0, -1);
                    console.log('‚úÇÔ∏è Removed checksum:', withoutChecksum);
                    
                    // 3. Position restoration
                    const unscrambled = this.unscramblePositions(withoutChecksum);
                    console.log('üîÑ After position restoration:', unscrambled);
                    
                    // 4. Character restoration
                    const restored = this.restoreChars(unscrambled);
                    console.log('üîÄ After character restoration:', restored);
                    
                    // 5. Base58 decode
                    const base58Decoded = this.fromBase58(restored);
                    console.log('üìù After Base58 decode:', base58Decoded);
                    
                    // 6. XOR decrypt
                    const decrypted = base58Decoded ^ this.secretKey;
                    console.log('üîì After XOR decrypt:', decrypted);
                    
                    return decrypted;
                    
                } catch (error) {
                    console.error('‚ùå Decode error:', error);
                    return null;
                }
            }
        }

        // Create global decoder instance
        const trackingDecoder = new ReversibleEncoder();
        
        // Cooldown management
        const COOLDOWN_SECONDS = 30;
        const STORAGE_KEY = 'tracking_last_query_time';
        let cooldownTimer = null;
        
        // Get last query time from localStorage
        function getLastQueryTime() {
            const stored = localStorage.getItem(STORAGE_KEY);
            return stored ? parseInt(stored, 10) : 0;
        }
        
        // Set last query time to localStorage
        function setLastQueryTime(timestamp) {
            localStorage.setItem(STORAGE_KEY, timestamp.toString());
        }

        // Decode and query function
        async function decodeAndQuery() {
            const trackingCode = document.getElementById('trackingCode').value.trim();
            const decodeBtn = document.getElementById('decodeBtn');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const decodeResult = document.getElementById('decodeResult');
            const decodedInfo = document.getElementById('decodedInfo');
            
            // Hide all result cards
            hideAllCards();
            
            if (!trackingCode) {
                showError('Please enter tracking code');
                return;
            }
            
            // Check cooldown
            const currentTime = Date.now();
            const lastQueryTime = getLastQueryTime();
            const timeSinceLastQuery = (currentTime - lastQueryTime) / 1000;
            
            if (timeSinceLastQuery < COOLDOWN_SECONDS && lastQueryTime > 0) {
                const remainingTime = Math.ceil(COOLDOWN_SECONDS - timeSinceLastQuery);
                showError(`Please wait ${remainingTime} seconds before making another query. (Refreshing page won't reset this timer)`);
                
                // Start cooldown countdown
                startCooldownCountdown(remainingTime);
                return;
            }
            
            // Show loading state
            decodeBtn.disabled = true;
            decodeBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Decoding...';
            loadingSpinner.style.display = 'block';
            
            try {
                // 1. Decode tracking code
                console.log('üîç Starting decode tracking code:', trackingCode);
                const galleryId = trackingDecoder.decode(trackingCode);
                
                if (!galleryId || galleryId <= 0) {
                    throw new Error('Invalid tracking code or decode failed');
                }
                
                console.log('‚úÖ Decode successful, Gallery ID:', galleryId);
                
                // Temporarily hide decode result display
                // // Show decode result
                // decodedInfo.innerHTML = `
                //     <div class="row">
                //         <div class="col-md-6">
                //             <strong>Original Tracking Code:</strong><br>
                //             <code class="text-primary">${trackingCode}</code>
                //         </div>
                //         <div class="col-md-6">
                //             <strong>Decoded Gallery ID:</strong><br>
                //             <code class="text-success">${galleryId}</code>
                //         </div>
                //     </div>
                // `;
                // decodeResult.style.display = 'block';
                
                // 2. Query access logs
                console.log('üìã Querying access logs...');
                const response = await fetch(`https://fetch.maipdf.com/api/get-access-logs?id=${galleryId}&code=${encodeURIComponent(trackingCode)}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå API response error:', response.status, errorText);
                    throw new Error(`API request failed: ${response.status} ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('üìä Query result:', result);
                
                if (result.success) {
                    // Update last query time on successful query
                    setLastQueryTime(Date.now());
                    displayResults(result);
                } else {
                    throw new Error(result.error || 'Failed to query access logs');
                }
                
            } catch (error) {
                console.error('‚ùå Query error:', error);
                showError(error.message);
            } finally {
                // Restore button state
                decodeBtn.disabled = false;
                decodeBtn.innerHTML = '<i class="fas fa-search me-2"></i>Decode & Query';
                loadingSpinner.style.display = 'none';
            }
        }
        
        // Global variables to store current data for re-rendering
        let currentGalleryInfo = null;
        let currentStatistics = null;
        let currentAccessLogs = null;

        // Display query results
        function displayResults(data) {
            const { galleryInfo, accessLogs, statistics } = data;
            
            // Store data for potential re-rendering when language changes
            currentGalleryInfo = galleryInfo;
            currentStatistics = statistics;
            currentAccessLogs = accessLogs;
            
            // Display gallery information
            displayGalleryInfo(galleryInfo);
            
            // Display statistics
            displayStatistics(statistics);
            
            // Display access logs
            displayAccessLogs(accessLogs);
        }
        
        // Re-render all dynamic content with current language
        function refreshDynamicTranslations() {
            if (currentGalleryInfo) {
                displayGalleryInfo(currentGalleryInfo);
            }
            if (currentStatistics) {
                displayStatistics(currentStatistics);
            }
            if (currentAccessLogs) {
                displayAccessLogs(currentAccessLogs);
            }
        }
        
        // Expose function to global scope for i18n system
        window.refreshDynamicTranslations = refreshDynamicTranslations;
        
        // Display gallery information
        function displayGalleryInfo(info) {
            const galleryInfoCard = document.getElementById('galleryInfoCard');
            const galleryInfo = document.getElementById('galleryInfo');
            
            // Get translations
            const i18n = window.trackingI18n;
            const viewLimitText = i18n ? i18n.t('gallery.viewLimit') : 'View Limit';
            const timeLimitText = i18n ? i18n.t('gallery.timeLimit') : 'Time Limit';
            const descriptionText = i18n ? i18n.t('gallery.description') : 'Description';
            const createdTimeText = i18n ? i18n.t('gallery.createdTime') : 'Created Time';
            const unlimitedText = i18n ? i18n.t('gallery.unlimited') : 'Unlimited';
            const timesText = i18n ? i18n.t('gallery.times') : 'times';
            const secondsText = i18n ? i18n.t('gallery.seconds') : 'seconds';
            const noDescriptionText = i18n ? i18n.t('gallery.noDescription') : 'No description';
            
            galleryInfo.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="fw-bold text-success">
                            <i class="fas fa-eye me-1"></i>${viewLimitText}
                        </h6>
                        <p class="mb-2">${info.email === 100000000 ? unlimitedText : info.email + ' ' + timesText}</p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="fw-bold text-success">
                            <i class="fas fa-clock me-1"></i>${timeLimitText}
                        </h6>
                        <p class="mb-2">${info.password === 1999999927 ? unlimitedText : info.password + ' ' + secondsText}</p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h6 class="fw-bold text-success">
                            <i class="fas fa-tag me-1"></i>${descriptionText}
                        </h6>
                        <p class="mb-2">${info.caption || noDescriptionText}</p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="fw-bold text-success">
                            <i class="fas fa-calendar me-1"></i>${createdTimeText}
                        </h6>
                        <p class="mb-2">${new Date(info.timestamp).toLocaleString()}</p>
                    </div>
                </div>
            `;
            
            galleryInfoCard.style.display = 'block';
        }
        
        // Display statistics
        function displayStatistics(stats) {
            const statisticsCard = document.getElementById('statisticsCard');
            const statsGrid = document.getElementById('statsGrid');
            
            // Get translations
            const i18n = window.trackingI18n;
            const totalAccessText = i18n ? i18n.t('statistics.totalAccess') : 'Total Access';
            const uniqueIPsText = i18n ? i18n.t('statistics.uniqueIPs') : 'Unique IPs';
            const differentBrowsersText = i18n ? i18n.t('statistics.differentBrowsers') : 'Different Browsers';
            const firstAccessText = i18n ? i18n.t('statistics.firstAccess') : 'First Access';
            
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.totalAccess}</div>
                    <div class="stat-label">${totalAccessText}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.uniqueIPs}</div>
                    <div class="stat-label">${uniqueIPsText}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.uniqueBrowsers}</div>
                    <div class="stat-label">${differentBrowsersText}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">
                        ${stats.firstAccess ? new Date(stats.firstAccess).toLocaleDateString() : 'N/A'}
                    </div>
                    <div class="stat-label">${firstAccessText}</div>
                </div>
            `;
            
            statisticsCard.style.display = 'block';
        }
        
        // Display access logs
        function displayAccessLogs(logs) {
            const accessLogsCard = document.getElementById('accessLogsCard');
            const accessLogsBody = document.getElementById('accessLogsBody');
            const logCount = document.getElementById('logCount');
            
            // Get translations
            const i18n = window.trackingI18n;
            const noLogsText = i18n ? i18n.t('accessLogs.noLogs') : 'No access logs yet';
            const directAccessText = i18n ? i18n.t('accessLogs.directAccess') : 'Direct Access';
            
            logCount.textContent = logs.length;
            
            if (logs.length === 0) {
                accessLogsBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-2x mb-2"></i><br>
                            ${noLogsText}
                        </td>
                    </tr>
                `;
            } else {
                accessLogsBody.innerHTML = logs.map(log => `
                    <tr>
                        <td>
                            <i class="fas fa-clock text-muted me-1"></i>
                            ${new Date(log.access_time).toLocaleString()}
                        </td>
                        <td>
                            <i class="fas fa-map-marker-alt text-muted me-1"></i>
                            <code>${log.ip_address}</code>
                        </td>
                        <td>
                            <i class="fas fa-desktop text-muted me-1"></i>
                            <small class="text-muted" style="font-family: monospace; word-break: break-all;">
                                ${log.user_agent || 'Unknown'}
                            </small>
                        </td>
                        <td>
                            <i class="fas fa-link text-muted me-1"></i>
                            <span class="text-truncate d-inline-block" style="max-width: 150px;" title="${log.referrer}">
                                ${log.referrer === 'direct' ? directAccessText : log.referrer}
                            </span>
                        </td>
                    </tr>
                `).join('');
            }
            
            accessLogsCard.style.display = 'block';
        }
        
        // Get browser name
        function getBrowserName(userAgent) {
            if (userAgent.includes('Chrome')) return 'Chrome';
            if (userAgent.includes('Firefox')) return 'Firefox';
            if (userAgent.includes('Safari')) return 'Safari';
            if (userAgent.includes('Edge')) return 'Edge';
            if (userAgent.includes('Opera')) return 'Opera';
            return 'Unknown Browser';
        }
        
        // Hide all cards
        function hideAllCards() {
            document.getElementById('galleryInfoCard').style.display = 'none';
            document.getElementById('statisticsCard').style.display = 'none';
            document.getElementById('accessLogsCard').style.display = 'none';
            document.getElementById('errorCard').style.display = 'none';
            document.getElementById('decodeResult').style.display = 'none';
        }
        
        // Show error message
        function showError(message) {
            const errorCard = document.getElementById('errorCard');
            const errorMessage = document.getElementById('errorMessage');
            
            errorMessage.textContent = message;
            errorCard.style.display = 'block';
        }
        
        // Start cooldown countdown
        function startCooldownCountdown(remainingSeconds) {
            const decodeBtn = document.getElementById('decodeBtn');
            
            // Clear any existing timer
            if (cooldownTimer) {
                clearInterval(cooldownTimer);
            }
            
            // Disable button and show countdown
            decodeBtn.disabled = true;
            
            cooldownTimer = setInterval(() => {
                if (remainingSeconds > 0) {
                    decodeBtn.innerHTML = `
                        <i class="fas fa-clock me-2"></i>
                        Wait ${remainingSeconds}s
                    `;
                    remainingSeconds--;
                } else {
                    // Cooldown finished
                    clearInterval(cooldownTimer);
                    cooldownTimer = null;
                    decodeBtn.disabled = false;
                    decodeBtn.innerHTML = '<i class="fas fa-search me-2"></i>Decode & Query';
                    
                    // Hide error message if it was showing cooldown
                    const errorMessage = document.getElementById('errorMessage');
                    if (errorMessage.textContent.includes('wait') || errorMessage.textContent.includes('Á≠âÂæÖ')) {
                        document.getElementById('errorCard').style.display = 'none';
                    }
                }
            }, 1000);
        }
        
        // Enter key support - wait for DOM to be ready
        function initializeEventListeners() {
            const trackingCodeInput = document.getElementById('trackingCode');
            if (trackingCodeInput) {
                trackingCodeInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        decodeAndQuery();
                    }
                });
            }
        }
        
        // Handle page visibility change (prevent cooldown bypass by tab switching)
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible') {
                // Check if we're still in cooldown when user returns to tab
                const currentTime = Date.now();
                const lastQueryTime = getLastQueryTime();
                const timeSinceLastQuery = (currentTime - lastQueryTime) / 1000;
                
                if (timeSinceLastQuery < COOLDOWN_SECONDS && lastQueryTime > 0) {
                    const remainingTime = Math.ceil(COOLDOWN_SECONDS - timeSinceLastQuery);
                    if (remainingTime > 0) {
                        startCooldownCountdown(remainingTime);
                    }
                }
            }
        });
        
        // Page initialization after loading
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìã Tracking page initialized');
            
            // Initialize event listeners
            initializeEventListeners();
            
            // Check if still in cooldown period after page load/refresh
            const currentTime = Date.now();
            const lastQueryTime = getLastQueryTime();
            const timeSinceLastQuery = (currentTime - lastQueryTime) / 1000;
            
            if (timeSinceLastQuery < COOLDOWN_SECONDS && lastQueryTime > 0) {
                const remainingTime = Math.ceil(COOLDOWN_SECONDS - timeSinceLastQuery);
                if (remainingTime > 0) {
                    console.log(`üïê Still in cooldown period: ${remainingTime} seconds remaining`);
                    showError(`Please wait ${remainingTime} seconds before making another query. (Refreshing page won't reset this timer)`);
                    startCooldownCountdown(remainingTime);
                }
            }
            
            // Auto-fill tracking code if provided in URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const trackingId = urlParams.get('id');
            if (code) {
                document.getElementById('trackingCode').value = code;
                // Only auto-query if not in cooldown
                if (!(timeSinceLastQuery < COOLDOWN_SECONDS && lastQueryTime > 0)) {
                    decodeAndQuery();
                }
            } else if (trackingId) {
                document.getElementById('trackingCode').value = trackingId;
                console.log('Ëá™Âä®Â°´ÂÖ•tracking code:', trackingId);
            }
        });
        
        // Gallery deletion functionality
        function showDeleteConfirmation() {
            if (!currentGalleryInfo) {
                showError('No gallery information available for deletion');
                return;
            }
            
            // Populate modal with gallery details
            const deleteConfirmDetails = document.getElementById('deleteConfirmDetails');
            const expectedConfirmCode = document.getElementById('expectedConfirmCode');
            const confirmCodeInput = document.getElementById('confirmCodeInput');
            
            const confirmCode = `DELETE-${currentGalleryInfo.auto}`;
            
            deleteConfirmDetails.innerHTML = `
                <div class="row">
                    <div class="col-sm-4"><strong>Gallery ID:</strong></div>
                    <div class="col-sm-8">${currentGalleryInfo.auto}</div>
                </div>
                <div class="row">
                    <div class="col-sm-4"><strong>Description:</strong></div>
                    <div class="col-sm-8">${currentGalleryInfo.caption || 'No description'}</div>
                </div>
                <div class="row">
                    <div class="col-sm-4"><strong>Current Views:</strong></div>
                    <div class="col-sm-8">${currentGalleryInfo.email === 100000000 ? 'Unlimited' : currentGalleryInfo.email}</div>
                </div>
            `;
            
            expectedConfirmCode.textContent = confirmCode;
            confirmCodeInput.value = '';
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            modal.show();
        }
        
        async function executeDelete() {
            if (!currentGalleryInfo) {
                showError('No gallery information available');
                return;
            }
            
            const confirmCodeInput = document.getElementById('confirmCodeInput');
            const executeDeleteBtn = document.getElementById('executeDeleteBtn');
            const confirmCode = confirmCodeInput.value.trim();
            const expectedCode = `DELETE-${currentGalleryInfo.auto}`;
            
            if (confirmCode !== expectedCode) {
                alert(`Invalid confirmation code. Please enter: ${expectedCode}`);
                confirmCodeInput.focus();
                return;
            }
            
            // Show loading state
            executeDeleteBtn.disabled = true;
            executeDeleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Deleting...';
            
            try {
                console.log(`üóëÔ∏è Attempting to delete gallery ${currentGalleryInfo.auto}`);
                
                const response = await fetch('https://fetch.maipdf.com/api/delete-gallery', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        galleryId: currentGalleryInfo.auto,
                        confirmCode: confirmCode
                    })
                });
                
                const result = await response.json();
                console.log('üóëÔ∏è Delete result:', result);
                
                if (result.success) {
                    // Hide modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
                    modal.hide();
                    
                    // Show success message
                    const successAlert = document.createElement('div');
                    successAlert.className = 'alert alert-success alert-dismissible fade show position-fixed';
                    successAlert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                    successAlert.innerHTML = `
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>Gallery Deleted Successfully!</strong><br>
                        Gallery ID ${result.galleryId} has been deleted (view count set to 0).
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(successAlert);
                    
                    // Update the current display to show 0 views
                    if (currentGalleryInfo) {
                        currentGalleryInfo.email = 0;
                        displayGalleryInfo(currentGalleryInfo);
                    }
                    
                    // Auto dismiss after 5 seconds
                    setTimeout(() => {
                        if (successAlert.parentElement) {
                            successAlert.remove();
                        }
                    }, 5000);
                    
                } else {
                    alert(`Delete failed: ${result.error}`);
                }
                
            } catch (error) {
                console.error('‚ùå Delete error:', error);
                alert(`Delete failed: ${error.message}`);
            } finally {
                // Restore button state
                executeDeleteBtn.disabled = false;
                executeDeleteBtn.innerHTML = '<i class="fas fa-trash me-1"></i>Delete Gallery';
            }
        }
    </script>
</body>
</html>