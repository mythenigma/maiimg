<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Dashboard - Image QR Generator</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="alternate icon" type="image/x-icon" href="favicon.ico">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
  <script src="i18n.js?v=2026021902"></script>
  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --text: #1e293b;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --success: #22c55e;
      --danger: #ef4444;
      --warning: #f59e0b;
    }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
    }
    .dash-nav {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 12px 0;
    }
    .dash-nav .container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 8px;
    }
    .dash-nav .brand {
      color: #fff;
      font-weight: 700;
      font-size: 1.15rem;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .dash-nav .nav-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .dash-nav .user-email {
      color: rgba(255,255,255,0.85);
      font-size: 0.85rem;
    }
    .dash-header {
      background: var(--card-bg);
      border-bottom: 1px solid var(--border);
      padding: 20px 0;
    }
    .dash-header h1 {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0;
    }
    .dash-header .stats {
      display: flex;
      gap: 20px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    .dash-header .stat-item {
      font-size: 0.9rem;
      color: var(--text-muted);
    }
    .dash-header .stat-item strong {
      color: var(--text);
    }
    .swap-bar {
      background: linear-gradient(135deg, #eef2ff 0%, #e8e0ff 100%);
      border: 1px solid #c7d2fe;
      border-radius: 12px;
      padding: 14px 20px;
      margin-bottom: 16px;
      display: none;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.1);
    }
    .swap-bar.active { display: flex; }
    .swap-bar .swap-info {
      font-size: 0.9rem;
      color: var(--primary-dark);
      font-weight: 500;
    }

    .toolbar-btn {
      border-radius: 8px;
      font-weight: 500;
      padding: 6px 14px;
      transition: all 0.2s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .replace-mode-btn {
      background: #fff;
      color: var(--primary);
      border: 1.5px solid var(--primary);
    }
    .replace-mode-btn:hover {
      background: var(--primary);
      color: #fff;
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(99, 102, 241, 0.25);
    }
    .replace-mode-btn.active-mode {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: #fff;
      border-color: transparent;
      box-shadow: 0 3px 10px rgba(99, 102, 241, 0.3);
    }
    .refresh-btn {
      background: #fff;
      color: var(--text-muted);
      border: 1.5px solid var(--border);
    }
    .refresh-btn:hover {
      background: #f1f5f9;
      color: var(--text);
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.08);
    }

    /* Table view (desktop) */
    .gallery-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: var(--card-bg);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }
    .gallery-table thead th {
      background: #f1f5f9;
      padding: 12px 16px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
    }
    .gallery-table tbody td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      font-size: 0.9rem;
      vertical-align: middle;
    }
    .gallery-table tbody tr:last-child td { border-bottom: none; }
    .gallery-table tbody tr:hover { background: #f8fafc; }
    .gallery-table .swap-check { width: 40px; }

    .badge-active { background: var(--success); color: #fff; }
    .badge-deleted { background: var(--danger); color: #fff; }
    .badge-expired { background: var(--warning); color: #fff; }

    .action-btn {
      border: none;
      background: none;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.85rem;
      transition: background 0.15s;
    }
    .action-btn:hover { background: #f1f5f9; }
    .action-btn.text-danger:hover { background: #fef2f2; }
    .action-btn.text-success:hover { background: #f0fdf4; }
    .action-btn.text-warning:hover { background: #fffbeb; }

    .gallery-link {
      color: var(--primary);
      text-decoration: none;
      font-family: monospace;
      font-size: 0.85rem;
    }
    .gallery-link:hover { text-decoration: underline; }

    .gallery-table-wrap {
      max-height: 70vh;
      overflow-y: auto;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }
    .gallery-table-wrap::-webkit-scrollbar { width: 6px; }
    .gallery-table-wrap::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 3px; }
    .gallery-table-wrap::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .gallery-table-wrap::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    .gallery-table thead th { position: sticky; top: 0; z-index: 1; }

    /* Card view (mobile) */
    .gallery-cards { display: none; }
    .gallery-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      border: 1px solid var(--border);
      position: relative;
    }
    .gallery-card.is-target {
      border-color: #3b82f6;
      background: #eff6ff;
    }
    .gallery-card.is-source {
      border-color: #f59e0b;
      background: #fffbeb;
    }
    .gallery-card .card-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }
    .gallery-card .card-top .card-id {
      font-weight: 700;
      font-size: 0.95rem;
    }
    .gallery-card .card-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      font-size: 0.85rem;
    }
    .gallery-card .card-row .label {
      color: var(--text-muted);
    }
    .gallery-card .replace-role-badge {
      position: absolute;
      top: 48px;
      right: 12px;
      font-size: 0.72rem;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid transparent;
    }
    .gallery-card .replace-role-badge.role-a {
      color: #1d4ed8;
      background: #dbeafe;
      border-color: #bfdbfe;
    }
    .gallery-card .replace-role-badge.role-b {
      color: #92400e;
      background: #fef3c7;
      border-color: #fde68a;
    }
    .gallery-card .replace-pick-row {
      margin-top: 10px;
      border-top: 1px dashed var(--border);
      padding-top: 10px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .gallery-card .pick-btn {
      border-radius: 10px;
      border: 1.5px solid var(--border);
      background: #fff;
      color: var(--text);
      font-size: 0.82rem;
      font-weight: 700;
      min-height: 40px;
      padding: 8px 10px;
    }
    .gallery-card .pick-btn.pick-target.active {
      border-color: #3b82f6;
      background: #dbeafe;
      color: #1d4ed8;
    }
    .gallery-card .pick-btn.pick-source.active {
      border-color: #f59e0b;
      background: #fef3c7;
      color: #92400e;
    }
    .gallery-card .pick-btn:active { transform: scale(0.98); }
    .gallery-card .card-actions {
      display: flex;
      gap: 4px;
      margin-top: 10px;
      flex-wrap: wrap;
      border-top: 1px solid var(--border);
      padding-top: 10px;
    }
    .gallery-card .swap-checkbox-wrap {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }
    .empty-state i { font-size: 3rem; margin-bottom: 16px; opacity: 0.4; }
    .empty-state h3 { font-size: 1.2rem; font-weight: 600; margin-bottom: 8px; }

    .loading-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .gallery-table thead th .tz-header-cell {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0;
    }
    .tz-picker {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 6px;
      padding: 5px 8px;
      background: #f1f5f9;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-weight: 400;
      text-transform: none;
      letter-spacing: 0;
    }
    .tz-picker .tz-icon {
      color: var(--primary);
      font-size: 0.8rem;
      flex-shrink: 0;
    }
    .tz-picker select {
      width: 130px;
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 0.75rem;
      color: var(--text);
      background: #fff;
      cursor: pointer;
      font-weight: 500;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .tz-picker select:hover {
      border-color: #94a3b8;
    }
    .tz-picker select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.15);
    }
    .gallery-table thead th.th-expiration {
      min-width: 160px;
      white-space: normal;
      text-align: center;
    }

    .help-btn {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 1.5px solid var(--border);
      background: #fff;
      color: var(--text-muted);
      font-size: 0.8rem;
      font-weight: 700;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      padding: 0;
    }
    .help-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
      background: #eef2ff;
      transform: scale(1.1);
    }

    .help-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(2px);
    }
    .help-overlay.show { display: flex; }
    .help-modal {
      background: #fff;
      border-radius: 16px;
      max-width: 720px;
      width: 92%;
      padding: 24px;
      position: relative;
      box-shadow: 0 20px 60px rgba(0,0,0,0.15);
      animation: helpIn 0.25s ease;
    }
    @keyframes helpIn {
      from { opacity: 0; transform: scale(0.92) translateY(10px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }
    .help-modal .close-btn {
      position: absolute;
      top: 12px;
      right: 14px;
      background: none;
      border: none;
      font-size: 1.3rem;
      color: var(--text-muted);
      cursor: pointer;
      line-height: 1;
      padding: 4px;
    }
    .help-modal .close-btn:hover { color: var(--text); }
    .help-modal h5 {
      font-weight: 700;
      margin-bottom: 14px;
      color: var(--text);
    }
    .help-modal picture {
      display: block;
    }
    .help-modal img {
      width: 100%;
      height: auto;
      border-radius: 10px;
      border: 1px solid var(--border);
    }
    .help-modal .help-desc {
      margin-top: 14px;
      font-size: 0.88rem;
      color: var(--text-muted);
      line-height: 1.6;
    }
    @media (max-width: 768px) {
      .help-modal {
        max-width: 440px;
        padding: 16px;
      }
      .help-modal img {
        border-radius: 12px;
      }
    }

    .toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 9999;
    }

    .tz-bar-mobile {
      display: none;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: #f1f5f9;
      border: 1px solid var(--border);
      border-radius: 8px;
    }
    .tz-bar-mobile-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin: 0;
      white-space: nowrap;
    }
    .tz-bar-mobile select {
      flex: 1;
      min-width: 0;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 0.8rem;
      color: var(--text);
      background: #fff;
      cursor: pointer;
    }
    .tz-bar-mobile select:focus {
      outline: none;
      border-color: var(--primary);
    }

    .mobile-replace-panel {
      display: none;
    }

    @media (max-width: 768px) {
      .gallery-table-wrap { display: none; }
      .gallery-cards { display: block; }
      .dash-header h1 { font-size: 1.25rem; }
      .tz-bar-mobile { display: flex; }
      .swap-bar,
      .swap-bar.active {
        display: none !important;
      }
      .mobile-replace-panel.show {
        display: block;
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1200;
        background: rgba(255,255,255,0.98);
        border-top: 1px solid var(--border);
        box-shadow: 0 -8px 20px rgba(15,23,42,0.12);
        padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      }
      body.mobile-replace-open {
        padding-bottom: 170px;
      }
      .mobile-replace-step {
        font-size: 0.84rem;
        font-weight: 700;
        color: var(--primary-dark);
        margin-bottom: 2px;
      }
      .mobile-replace-summary {
        font-size: 0.78rem;
        color: var(--text-muted);
        margin-bottom: 8px;
      }
      .mobile-replace-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }
      .mobile-replace-actions .btn {
        min-height: 42px;
        font-size: 0.9rem;
        font-weight: 700;
      }
    }
    @media (min-width: 769px) {
      .gallery-table-wrap { display: block; }
      .gallery-cards { display: none; }
    }
  </style>
</head>
<body>

<!-- Navbar -->
<nav class="dash-nav">
  <div class="container">
    <a class="brand" href="maiimg.html">
      <i class="fas fa-images"></i>
      <span data-translate="nav.title">Image QR Generator</span>
    </a>
    <div class="nav-right">
      <span class="user-email" id="navEmail"></span>
      <a href="maiimg.html" class="btn btn-sm btn-light">
        <i class="fas fa-plus me-1"></i><span data-translate="dash.newGallery">New Gallery</span>
      </a>
      <button class="btn btn-sm btn-outline-light" id="logoutBtn" onclick="logout()">
        <i class="fas fa-sign-out-alt me-1"></i><span data-translate="auth.logout">Logout</span>
      </button>
      <div class="dropdown">
        <button class="btn btn-sm btn-outline-light dropdown-toggle" type="button" id="languageDropdown" data-bs-toggle="dropdown" aria-expanded="false">
          <span id="currentLanguageFlag">üá∫üá∏</span>
          <span id="currentLanguageName">English</span>
        </button>
        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="languageDropdown">
          <li><a class="dropdown-item" href="#" onclick="changeLanguage('en')">üá∫üá∏ English</a></li>
          <li><a class="dropdown-item" href="#" onclick="changeLanguage('zh')">üá®üá≥ ‰∏≠Êñá</a></li>
          <li><a class="dropdown-item" href="#" onclick="changeLanguage('tw')">üáπüáº ‰∏≠ËèØÊ∞ëÂúã</a></li>
          <li><a class="dropdown-item" href="#" onclick="changeLanguage('ja')">üáØüáµ Êó•Êú¨Ë™û</a></li>
          <li><a class="dropdown-item" href="#" onclick="changeLanguage('de')">üá©üá™ Deutsch</a></li>
          <li><a class="dropdown-item" href="#" onclick="changeLanguage('ko')">üá∞üá∑ ÌïúÍµ≠Ïñ¥</a></li>
          <li><a class="dropdown-item" href="#" onclick="changeLanguage('fr')">üá´üá∑ Fran√ßais</a></li>
          <li><a class="dropdown-item" href="#" onclick="changeLanguage('it')">üáÆüáπ Italiano</a></li>
        </ul>
      </div>
    </div>
  </div>
</nav>

<!-- Header -->
<div class="dash-header">
  <div class="container">
    <h1><i class="fas fa-th-large me-2"></i><span data-translate="dash.title">My Galleries</span></h1>
    <div class="stats" id="statsBar">
      <div class="stat-item"><span data-translate="dash.total">Total</span>: <strong id="statTotal">0</strong></div>
      <div class="stat-item"><span data-translate="dash.active">Active</span>: <strong id="statActive">0</strong></div>
      <div class="stat-item"><span data-translate="dash.deleted">Deleted</span>: <strong id="statDeleted">0</strong></div>
    </div>
  </div>
</div>

<!-- Main Content -->
<div class="container py-3">

  <!-- Replace Bar -->
  <div class="swap-bar" id="replaceBar">
    <div class="swap-info">
      <i class="fas fa-copy me-1"></i>
      <span id="replaceStatus" data-translate="dash.replaceHint">Select target (A), then source (B). B's settings will be copied to A.</span>
    </div>
    <div>
      <button class="btn btn-sm btn-outline-secondary me-1" onclick="cancelReplace()">
        <span data-translate="dash.cancel">Cancel</span>
      </button>
      <button class="btn btn-sm btn-primary" id="replaceBtn" onclick="executeReplace()" disabled>
        <i class="fas fa-copy me-1"></i><span data-translate="dash.replaceConfirm">Replace</span>
      </button>
    </div>
  </div>

  <!-- Timezone bar (mobile only: shown above cards when table is hidden) -->
  <div class="tz-bar-mobile mb-2" id="tzBarMobile">
    <label class="tz-bar-mobile-label"><i class="fas fa-globe-americas me-1"></i><span data-translate="dash.expirationTz">Expiration timezone</span></label>
    <select id="tzSelectMobile" onchange="onTzChange(this)"></select>
  </div>

  <!-- Toolbar -->
  <div class="mb-3 d-flex justify-content-end gap-2 align-items-center">
    <button class="help-btn" onclick="showHelp()" title="Help">?</button>
    <button class="btn btn-sm toolbar-btn replace-mode-btn" id="replaceModeBtn" onclick="toggleReplaceMode()">
      <i class="fas fa-copy me-1"></i><span data-translate="dash.replaceMode">Replace Mode</span>
    </button>
    <button class="btn btn-sm toolbar-btn refresh-btn" onclick="loadGalleries()">
      <i class="fas fa-sync-alt me-1"></i><span data-translate="dash.refresh">Refresh</span>
    </button>
  </div>

  <!-- Help Modal -->
  <div class="help-overlay" id="helpOverlay" onclick="if(event.target===this)closeHelp()">
    <div class="help-modal">
      <button class="close-btn" onclick="closeHelp()">&times;</button>
      <h5><i class="fas fa-info-circle me-2 text-primary"></i><span data-translate="dash.helpTitle">How Replace Mode Works</span></h5>
      <picture>
        <source media="(max-width: 768px)" srcset="replace-help-mobile.svg">
        <img src="replace-help.png" alt="Replace Mode Explanation">
      </picture>
      <div class="help-desc" data-translate="dash.helpDesc">
        Select a deleted gallery as target (A), then pick an active gallery as source (B). B's content and settings will be copied to A, while A's original link stays the same. This lets you reuse an existing link with new content.
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div class="loading-state" id="loadingState">
    <div class="spinner-border text-primary mb-3" role="status"></div>
    <p data-translate="dash.loading">Loading galleries...</p>
  </div>

  <!-- Empty -->
  <div class="empty-state d-none" id="emptyState">
    <i class="fas fa-images d-block"></i>
    <h3 data-translate="dash.noGalleries">No galleries yet</h3>
    <p data-translate="dash.createFirst">Create your first gallery on the main page.</p>
    <a href="maiimg.html" class="btn btn-primary btn-sm mt-2">
      <i class="fas fa-plus me-1"></i><span data-translate="dash.newGallery">New Gallery</span>
    </a>
  </div>

  <!-- Table View (Desktop) -->
  <div class="gallery-table-wrap d-none" id="tableWrap">
    <table class="gallery-table">
      <thead>
        <tr>
          <th class="replace-col d-none" id="thTarget" style="width:50px">A</th>
          <th class="replace-col d-none" id="thSource" style="width:50px">B</th>
          <th>ID</th>
          <th data-translate="dash.colCaption">Caption</th>
          <th data-translate="dash.colViews">Views</th>
          <th data-translate="dash.colDuration">Duration</th>
          <th class="th-expiration">
            <div class="tz-header-cell">
              <span data-translate="dash.colExpiration">Expiration</span>
              <div class="tz-picker">
                <i class="fas fa-globe-americas tz-icon"></i>
                <select id="tzSelect" onchange="onTzChange(this)" title="Timezone for expiration display"></select>
              </div>
            </div>
          </th>
          <th data-translate="dash.colLink">Link</th>
          <th data-translate="dash.colStatus">Status</th>
          <th data-translate="dash.colActions">Actions</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <!-- Card View (Mobile) -->
  <div class="gallery-cards d-none" id="cardsWrap"></div>

  <!-- Replace Footer (Mobile) -->
  <div class="mobile-replace-panel" id="mobileReplacePanel">
    <div class="mobile-replace-step" id="mobileReplaceStep">Step 1: Select target A</div>
    <div class="mobile-replace-summary" id="mobileReplaceSummary">Choose A and B from cards below.</div>
    <div class="mobile-replace-actions">
      <button class="btn btn-outline-secondary btn-sm" onclick="cancelReplace()">Cancel</button>
      <button class="btn btn-primary btn-sm" id="mobileReplaceBtn" onclick="executeReplace()" disabled>Replace</button>
    </div>
  </div>

</div>

<!-- Toast -->
<div class="toast-container" id="toastContainer"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script>
const API_BASE = 'https://fetch.maipdf.com';
let galleries = [];
let replaceMode = false;
let replaceTarget = null; // A: the gallery link to keep
let replaceSource = null; // B: the gallery whose settings to copy

class ReversibleEncoder {
  constructor() {
    this.charset = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789abcdefghjkmnpqrstuvwxyz';
    this.base = this.charset.length;
    this.secretKey = 0x5A5A5A5A;
    this.charMap = {
      'A':'X','B':'Y','C':'Z','D':'a','E':'b','F':'c','G':'d','H':'e',
      'J':'f','K':'g','L':'h','M':'j','N':'k','P':'m','Q':'n','R':'p',
      'S':'q','T':'r','U':'s','V':'t','W':'u','X':'v','Y':'w','Z':'x',
      '2':'y','3':'z','4':'A','5':'B','6':'C','7':'D','8':'E','9':'F',
      'a':'G','b':'H','c':'J','d':'K','e':'L','f':'M','g':'N','h':'P',
      'j':'Q','k':'R','m':'S','n':'T','p':'U','q':'V','r':'W','s':'2',
      't':'3','u':'4','v':'5','w':'6','x':'7','y':'8','z':'9'
    };
    this.reverseCharMap = {};
    for (let [k, v] of Object.entries(this.charMap)) this.reverseCharMap[v] = k;
  }
  calculateChecksum(str) {
    let sum = 0;
    for (let i = 0; i < str.length; i++) sum += str.charCodeAt(i) * (i + 1);
    return this.charset[sum % this.base];
  }
  toBase58(num) {
    if (num === 0) return this.charset[0];
    let r = '';
    while (num > 0) { r = this.charset[num % this.base] + r; num = Math.floor(num / this.base); }
    return r;
  }
  substituteChars(str) { return str.split('').map(c => this.charMap[c] || c).join(''); }
  scramblePositions(str) {
    const chars = str.split(''), result = [];
    for (let i = 1; i < chars.length; i += 2) result.push(chars[i]);
    for (let i = 0; i < chars.length; i += 2) result.push(chars[i]);
    return result.join('');
  }
  encode(autoId) {
    const encrypted = autoId ^ this.secretKey;
    const base58 = this.toBase58(encrypted);
    const substituted = this.substituteChars(base58);
    const scrambled = this.scramblePositions(substituted);
    return scrambled + this.calculateChecksum(scrambled);
  }
}

const encoder = new ReversibleEncoder();

function encodeGalleryId(numericId) {
  return numericId.toString().split('').map(d => {
    let v = parseInt(d); if (v === 0) v = 10;
    return String.fromCharCode(64 + v);
  }).join('');
}

function getToken() { return sessionStorage.getItem('maiimg_jwt'); }

function i(key, fallback, vars) {
  let text = (window.i18n && window.i18n.t) ? (window.i18n.t(key) || fallback) : fallback;
  if (vars) {
    Object.keys(vars).forEach(k => {
      text = text.replace(new RegExp(`#\\{${k}\\}|\\{${k}\\}`, 'g'), vars[k]);
    });
  }
  return text;
}

function getGalleryStatus(g) {
  if (parseInt(g.viewLimit) === 0) return 'deleted';
  if (g.endtime) {
    const end = new Date(g.endtime);
    if (!isNaN(end.getTime()) && end < new Date()) return 'expired';
  }
  return 'active';
}

function statusBadge(status) {
  const labels = {
    active: i('dash.statusActive', 'Active'),
    deleted: i('dash.statusDeleted', 'Deleted'),
    expired: i('dash.statusExpired', 'Expired')
  };
  const cls = { active: 'badge-active', deleted: 'badge-deleted', expired: 'badge-expired' };
  return `<span class="badge ${cls[status]}">${labels[status]}</span>`;
}

function formatDuration(seconds) {
  const s = parseInt(seconds);
  if (!s || s <= 0 || s >= 1999999927) return i('dash.unlimited', 'Unlimited');
  if (s < 60) return `${s}s`;
  if (s < 3600) return `${Math.floor(s / 60)}m ${s % 60 ? (s % 60) + 's' : ''}`.trim();
  const h = Math.floor(s / 3600);
  const m = Math.floor((s % 3600) / 60);
  return `${h}h ${m ? m + 'm' : ''}`.trim();
}

function formatEndtime(ts) {
  if (!ts) return i('dash.never', 'Never');
  const ms = parseInt(ts) * 1000;
  if (isNaN(ms) || ms <= 0) return i('dash.never', 'Never');
  const d = new Date(ms);
  const formatted = new Intl.DateTimeFormat('en-CA', {
    timeZone: currentTz,
    year: 'numeric', month: '2-digit', day: '2-digit',
    hour: '2-digit', minute: '2-digit', hour12: false
  }).format(d).replace(',', '');
  if (d < new Date()) return `<span class="text-danger">${formatted}</span>`;
  return formatted;
}

function galleryLink(id) {
  const alphaId = encodeGalleryId(id);
  return `https://maiimg.com/gallery/${alphaId}`;
}

function trackingLink(id) {
  const code = encoder.encode(id);
  return `tracking.html?code=${code}`;
}

// ---- Auth Gate ----
function checkAuth() {
  const token = getToken();
  if (!token) {
    window.location.href = 'maiimg.html';
    return false;
  }
  try {
    const parts = token.split('.');
    const payload = JSON.parse(atob(parts[1].replace(/-/g,'+').replace(/_/g,'/')));
    document.getElementById('navEmail').textContent = payload.sub || '';
    if (payload.exp && payload.exp * 1000 < Date.now()) {
      sessionStorage.removeItem('maiimg_jwt');
      window.location.href = 'maiimg.html';
      return false;
    }
  } catch (e) {
    window.location.href = 'maiimg.html';
    return false;
  }
  return true;
}

function logout() {
  sessionStorage.removeItem('maiimg_jwt');
  sessionStorage.removeItem('maiimg_user');
  window.location.href = 'maiimg.html';
}

// ---- Load Galleries ----
async function loadGalleries() {
  const token = getToken();
  document.getElementById('loadingState').classList.remove('d-none');
  document.getElementById('emptyState').classList.add('d-none');
  document.getElementById('tableWrap').classList.add('d-none');
  document.getElementById('cardsWrap').classList.add('d-none');

  try {
    const res = await fetch(`${API_BASE}/api/user/galleries`, {
      headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
    });
    const data = await res.json();
    if (data.status !== 'ok') throw new Error(data.error || 'Failed');

    galleries = data.galleries || [];
    document.getElementById('loadingState').classList.add('d-none');

    if (galleries.length === 0) {
      document.getElementById('emptyState').classList.remove('d-none');
      return;
    }

    updateStats();
    renderTable();
    renderCards();
    document.getElementById('tableWrap').classList.remove('d-none');
    document.getElementById('cardsWrap').classList.remove('d-none');
  } catch (err) {
    document.getElementById('loadingState').classList.add('d-none');
    showToast('Failed to load galleries: ' + err.message, 'danger');
  }
}

function updateStats() {
  let active = 0, deleted = 0;
  galleries.forEach(g => {
    const s = getGalleryStatus(g);
    if (s === 'deleted') deleted++;
    else active++;
  });
  document.getElementById('statTotal').textContent = galleries.length;
  document.getElementById('statActive').textContent = active;
  document.getElementById('statDeleted').textContent = deleted;
}

// ---- Table Render ----
function renderTable() {
  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = galleries.map(g => {
    const status = getGalleryStatus(g);
    const link = galleryLink(g.id);
    const replaceCols = replaceMode ? `
      <td class="replace-col"><input type="radio" name="replaceTarget" class="form-check-input" value="${g.id}" ${replaceTarget === g.id ? 'checked' : ''} onchange="onPickTarget(${g.id})"></td>
      <td class="replace-col"><input type="radio" name="replaceSource" class="form-check-input" value="${g.id}" ${replaceSource === g.id ? 'checked' : ''} onchange="onPickSource(${g.id})"></td>
    ` : '';
    return `<tr ${replaceTarget === g.id ? 'style="background:#dbeafe"' : ''} ${replaceSource === g.id ? 'style="background:#fef3c7"' : ''}>
      ${replaceCols}
      <td><strong>#${g.id}</strong></td>
      <td>${escHtml(g.caption || '-')}</td>
      <td>${g.viewLimit}</td>
      <td>${formatDuration(g.viewDuration)}</td>
      <td>${formatEndtime(g.endtime)}</td>
      <td><a class="gallery-link" href="${link}" target="_blank">${link.replace('https://','')}</a></td>
      <td>${statusBadge(status)}</td>
      <td class="text-nowrap">
        <a href="${trackingLink(g.id)}" class="action-btn text-primary" title="${i('dash.accessRecord','Access Record')}"><i class="fas fa-chart-line"></i></a>
        ${status === 'active' ? `<button class="action-btn text-danger" onclick="deleteGallery(${g.id})" title="${i('dash.delete','Delete')}"><i class="fas fa-trash-alt"></i></button>` : ''}
        ${status === 'deleted' ? `<button class="action-btn text-success" onclick="startRestoreFor(${g.id})" title="${i('dash.restore','Restore')}"><i class="fas fa-undo-alt"></i></button>` : ''}
      </td>
    </tr>`;
  }).join('');
}

// ---- Card Render (Mobile) ----
function renderCards() {
  const wrap = document.getElementById('cardsWrap');
  wrap.innerHTML = galleries.map(g => {
    const status = getGalleryStatus(g);
    const link = galleryLink(g.id);
    const cardClass = `gallery-card${replaceTarget === g.id ? ' is-target' : ''}${replaceSource === g.id ? ' is-source' : ''}`;
    const roleBadge = replaceTarget === g.id
      ? `<span class="replace-role-badge role-a">${i('dash.mobileRoleTarget','Target A')}</span>`
      : (replaceSource === g.id ? `<span class="replace-role-badge role-b">${i('dash.mobileRoleSource','Source B')}</span>` : '');
    return `<div class="${cardClass}">
      <div class="card-top">
        <span class="card-id">#${g.id}</span>
        ${statusBadge(status)}
      </div>
      ${roleBadge}
      <div class="card-row"><span class="label">${i('dash.colCaption','Caption')}</span><span>${escHtml(g.caption || '-')}</span></div>
      <div class="card-row"><span class="label">${i('dash.colViews','Views')}</span><span>${g.viewLimit}</span></div>
      <div class="card-row"><span class="label">${i('dash.colDuration','Duration')}</span><span>${formatDuration(g.viewDuration)}</span></div>
      <div class="card-row"><span class="label">${i('dash.colExpiration','Expiration')}</span><span>${formatEndtime(g.endtime)}</span></div>
      <div class="card-row"><span class="label">${i('dash.colLink','Link')}</span><a class="gallery-link" href="${link}" target="_blank">${link.replace('https://','').substring(0,28)}...</a></div>
      ${replaceMode ? `
        <div class="replace-pick-row">
          <button class="pick-btn pick-target ${replaceTarget === g.id ? 'active' : ''}" onclick="onPickTarget(${g.id})">${i('dash.mobileSetTarget','Set as A')}</button>
          <button class="pick-btn pick-source ${replaceSource === g.id ? 'active' : ''}" onclick="onPickSource(${g.id})">${i('dash.mobileSetSource','Set as B')}</button>
        </div>
      ` : ''}
      <div class="card-actions">
        <a href="${trackingLink(g.id)}" class="action-btn text-primary"><i class="fas fa-chart-line me-1"></i>${i('dash.accessRecord','Access Record')}</a>
        ${status === 'active' ? `<button class="action-btn text-danger" onclick="deleteGallery(${g.id})"><i class="fas fa-trash-alt me-1"></i>${i('dash.delete','Delete')}</button>` : ''}
        ${status === 'deleted' ? `<button class="action-btn text-success" onclick="startRestoreFor(${g.id})"><i class="fas fa-undo-alt me-1"></i>${i('dash.restore','Restore')}</button>` : ''}
      </div>
    </div>`;
  }).join('');
}

// ---- Delete Gallery ----
async function deleteGallery(id) {
  if (!confirm(i('dash.confirmDelete', `Delete gallery #${id}? This will set views to 0.`, { id }))) return;
  try {
    const res = await fetch(`${API_BASE}/api/delete-gallery`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${getToken()}`
      },
      body: JSON.stringify({ galleryId: id, confirmCode: `DELETE-${id}` })
    });
    const data = await res.json();
    if (data.success) {
      showToast(i('dash.deletedToast', `Gallery #${id} deleted`, { id }), 'success');
      loadGalleries();
    } else {
      showToast(data.error || 'Delete failed', 'danger');
    }
  } catch (err) {
    showToast('Delete failed: ' + err.message, 'danger');
  }
}

// ---- Replace Mode ----
function toggleReplaceMode() {
  replaceMode = !replaceMode;
  replaceTarget = null;
  replaceSource = null;
  const bar = document.getElementById('replaceBar');
  const btn = document.getElementById('replaceModeBtn');
  const thTarget = document.getElementById('thTarget');
  const thSource = document.getElementById('thSource');
  if (replaceMode) {
    bar.classList.add('active');
    btn.classList.add('active-mode');
    thTarget.classList.remove('d-none');
    thSource.classList.remove('d-none');
  } else {
    bar.classList.remove('active');
    btn.classList.remove('active-mode');
    thTarget.classList.add('d-none');
    thSource.classList.add('d-none');
  }
  renderTable();
  renderCards();
  updateReplaceUI();
}

function cancelReplace() {
  replaceMode = false;
  replaceTarget = null;
  replaceSource = null;
  document.getElementById('replaceBar').classList.remove('active');
  document.getElementById('replaceModeBtn').classList.remove('active-mode');
  document.getElementById('thTarget').classList.add('d-none');
  document.getElementById('thSource').classList.add('d-none');
  renderTable();
  renderCards();
  updateReplaceUI();
}

function onPickTarget(id) {
  replaceTarget = id;
  if (replaceSource === id) replaceSource = null;
  renderTable();
  renderCards();
  updateReplaceUI();
}

function onPickSource(id) {
  replaceSource = id;
  if (replaceTarget === id) replaceTarget = null;
  renderTable();
  renderCards();
  updateReplaceUI();
}

function updateReplaceUI() {
  const btn = document.getElementById('replaceBtn');
  const btnMobile = document.getElementById('mobileReplaceBtn');
  const status = document.getElementById('replaceStatus');
  if (replaceTarget && replaceSource) {
    btn.disabled = false;
    if (btnMobile) btnMobile.disabled = false;
    status.innerHTML = `<strong>#${replaceTarget}</strong> (A) ‚Üê <strong>#${replaceSource}</strong> (B)`;
  } else {
    btn.disabled = true;
    if (btnMobile) btnMobile.disabled = true;
    const hint = i('dash.replaceHint', 'Select target A, then source B. All of B\'s settings will be copied to A.');
    status.textContent = hint;
  }
  updateMobileReplacePanel();
}

function updateMobileReplacePanel() {
  const panel = document.getElementById('mobileReplacePanel');
  const step = document.getElementById('mobileReplaceStep');
  const summary = document.getElementById('mobileReplaceSummary');
  if (!panel || !step || !summary) return;

  const mobile = window.matchMedia('(max-width: 768px)').matches;
  if (!replaceMode || !mobile) {
    panel.classList.remove('show');
    document.body.classList.remove('mobile-replace-open');
    return;
  }

  panel.classList.add('show');
  document.body.classList.add('mobile-replace-open');

  if (!replaceTarget) {
    step.textContent = i('dash.mobileStep1', 'Step 1: Select target A');
    summary.textContent = i('dash.mobileHint', 'Choose A and B from cards below.');
  } else if (!replaceSource) {
    step.textContent = i('dash.mobileStep2', 'Step 2: Select source B');
    summary.textContent = i('dash.mobilePickedTarget', 'Selected A: #{target}. Now pick B.', { target: replaceTarget });
  } else {
    step.textContent = i('dash.mobileReady', 'Ready to replace');
    summary.textContent = i('dash.mobileReadySummary', 'A #{target} will be replaced by B #{source}.', { target: replaceTarget, source: replaceSource });
  }
}

async function executeReplace() {
  if (!replaceTarget || !replaceSource) return;
  const srcG = galleries.find(g => g.id === replaceSource);
  const msg = i('dash.confirmReplace',
    `Replace #${replaceTarget} (A) with all settings from #${replaceSource} (B)?\n\nA will get B's: images, views (${srcG?.viewLimit || '?'}), caption, password, expiration.\nA's link stays the same.`,
    { target: replaceTarget, source: replaceSource, views: srcG?.viewLimit || '?' });
  if (!confirm(msg)) return;
  try {
    const res = await fetch(`${API_BASE}/api/user/replace-gallery`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${getToken()}`
      },
      body: JSON.stringify({ targetId: replaceTarget, sourceId: replaceSource })
    });
    const data = await res.json();
    if (data.status === 'ok') {
      showToast(i('dash.replacedToast', `#${replaceTarget} replaced with #${replaceSource}'s settings`, { target: replaceTarget, source: replaceSource }), 'success');
      cancelReplace();
      loadGalleries();
    } else {
      showToast(data.error || 'Replace failed', 'danger');
    }
  } catch (err) {
    showToast('Replace failed: ' + err.message, 'danger');
  }
}

// ---- Restore (activates replace mode with target pre-selected) ----
function startRestoreFor(id) {
  replaceMode = true;
  replaceTarget = id;
  replaceSource = null;
  const bar = document.getElementById('replaceBar');
  const btn = document.getElementById('replaceModeBtn');
  const thTarget = document.getElementById('thTarget');
  const thSource = document.getElementById('thSource');
  bar.classList.add('active');
  btn.classList.add('active-mode');
  thTarget.classList.remove('d-none');
  thSource.classList.remove('d-none');
  renderTable();
  renderCards();
  updateReplaceUI();
  showToast(i('dash.restoreHint', `Gallery #${id} selected as target (A). Now pick a source (B) to copy from.`, { id }), 'info');
}

// ---- Timezone ----
let currentTz = 'UTC';

const tzData = [
  { id: 'UTC', label: 'UTC', short: 'UTC' },
  { id: 'Asia/Shanghai', label: 'China (UTC+8)', short: '+8' },
  { id: 'Asia/Tokyo', label: 'Japan (UTC+9)', short: '+9' },
  { id: 'Asia/Seoul', label: 'Korea (UTC+9)', short: '+9' },
  { id: 'Asia/Singapore', label: 'Singapore (UTC+8)', short: '+8' },
  { id: 'Asia/Kolkata', label: 'India (UTC+5:30)', short: '+5:30' },
  { id: 'Europe/London', label: 'UK (UTC+0/+1)', short: '+0' },
  { id: 'Europe/Berlin', label: 'Germany (UTC+1)', short: '+1' },
  { id: 'Europe/Paris', label: 'France (UTC+1)', short: '+1' },
  { id: 'Asia/Dubai', label: 'UAE (UTC+4)', short: '+4' },
  { id: 'Australia/Sydney', label: 'Australia (UTC+10)', short: '+10' },
  { id: 'America/New_York', label: 'US Eastern (UTC-5)', short: '-5' },
  { id: 'America/Chicago', label: 'US Central (UTC-6)', short: '-6' },
  { id: 'America/Denver', label: 'US Mountain (UTC-7)', short: '-7' },
  { id: 'America/Los_Angeles', label: 'US Pacific (UTC-8)', short: '-8' },
  { id: 'America/Sao_Paulo', label: 'Brazil (UTC-3)', short: '-3' },
  { id: 'Europe/Moscow', label: 'Russia (UTC+3)', short: '+3' },
  { id: 'America/Toronto', label: 'Canada (UTC-5)', short: '-5' }
];

function initTzSelect() {
  const sel = document.getElementById('tzSelect');
  const selMobile = document.getElementById('tzSelectMobile');
  const fill = (target) => {
    if (!target) return;
    target.innerHTML = '';
    tzData.forEach(z => {
      const opt = document.createElement('option');
      opt.value = z.id;
      opt.textContent = z.label;
      target.appendChild(opt);
    });
  };
  fill(sel);
  fill(selMobile);

  const saved = localStorage.getItem('dash_tz');
  if (saved && tzData.find(z => z.id === saved)) {
    currentTz = saved;
  } else {
    try {
      const browserTz = Intl.DateTimeFormat().resolvedOptions().timeZone || '';
      const match = tzData.find(z => z.id === browserTz);
      if (match) {
        currentTz = match.id;
      } else {
        const localOffset = new Date().getTimezoneOffset();
        let best = null, bestDiff = Infinity;
        tzData.forEach(z => {
          try {
            const parts = new Intl.DateTimeFormat('en-US', {
              timeZone: z.id, year:'numeric', month:'2-digit', day:'2-digit',
              hour:'2-digit', minute:'2-digit', hour12: false
            }).formatToParts(new Date());
            const vals = {};
            parts.forEach(p => vals[p.type] = parseInt(p.value));
            const tzDate = new Date(vals.year, vals.month - 1, vals.day, vals.hour, vals.minute);
            const utcDate = new Date(new Date().toISOString().slice(0, 19));
            const off = (utcDate - tzDate) / 60000;
            const diff = Math.abs(off - localOffset);
            if (diff < bestDiff) { bestDiff = diff; best = z; }
          } catch(e) {}
        });
        if (best && bestDiff <= 30) currentTz = best.id;
      }
    } catch(e) {}
  }
  if (sel) sel.value = currentTz;
  if (selMobile) selMobile.value = currentTz;
}

function onTzChange(fromEl) {
  const val = (fromEl && fromEl.value !== undefined) ? fromEl.value : (document.getElementById('tzSelect') || {}).value;
  if (!val) return;
  currentTz = val;
  const sel = document.getElementById('tzSelect');
  const selMobile = document.getElementById('tzSelectMobile');
  if (sel) sel.value = currentTz;
  if (selMobile) selMobile.value = currentTz;
  localStorage.setItem('dash_tz', currentTz);
  if (galleries.length > 0) {
    renderTable();
    renderCards();
  }
}

initTzSelect();
window.addEventListener('resize', updateMobileReplacePanel);

// ---- Help Modal ----
function showHelp() { document.getElementById('helpOverlay').classList.add('show'); }
function closeHelp() { document.getElementById('helpOverlay').classList.remove('show'); }

// ---- Utils ----
function escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function showToast(msg, type = 'info') {
  const c = document.getElementById('toastContainer');
  const id = 'toast-' + Date.now();
  const bgClass = type === 'success' ? 'bg-success' : type === 'danger' ? 'bg-danger' : 'bg-primary';
  c.insertAdjacentHTML('beforeend', `
    <div id="${id}" class="toast align-items-center text-white ${bgClass} border-0 show" role="alert">
      <div class="d-flex">
        <div class="toast-body">${escHtml(msg)}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  `);
  setTimeout(() => {
    const el = document.getElementById(id);
    if (el) el.remove();
  }, 4000);
}

// ---- Init ----
if (checkAuth()) {
  loadGalleries();
}

function changeLanguage(lang) {
  if (window.i18n) {
    window.i18n.setLanguage(lang);
    localStorage.setItem('preferred-language', lang);
    const pageTitle = window.i18n.t('dash.pageTitle');
    if (pageTitle) document.title = pageTitle;
    if (galleries.length > 0) {
      renderTable();
      renderCards();
    }
  }
}

if (window.i18n) {
  window.i18n.onReady(() => {
    document.querySelectorAll('[data-translate]').forEach(el => {
      const key = el.getAttribute('data-translate');
      const translated = window.i18n.t(key);
      if (translated) el.textContent = translated;
    });
    const pageTitle = window.i18n.t('dash.pageTitle');
    if (pageTitle) document.title = pageTitle;
    window.i18n.updateLanguageSelector();
  });
}
</script>
</body>
</html>
